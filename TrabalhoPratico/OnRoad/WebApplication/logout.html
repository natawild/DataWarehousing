<!DOCTYPE html>
<html>
<head>
    <title>Logout</title>
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="jquery/themes/bizagiDefault/devices/desktop/opensans-font.css" />
    <link rel="stylesheet" href="css/logout.css">
    <link type="image/x-icon" rel="icon" href="favicon.ico" />

    <script type='text/javascript' src='jquery/bizagi.configuration.js'></script>
    <script type='text/javascript' src='jquery/steal.js'></script>
    <script type='text/javascript' src='jquery/bizagi.loader.js'></script>
</head>
<body>
    <script type="text/javascript">

        var isIE = function () {
            return (navigator.appName.indexOf("Internet Explorer") > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./));
        }

        var isIE8 = function () {
            return isIE() && document.documentMode == 8;
        };

        if (!String.prototype.endsWith) {
            String.prototype.endsWith = function (searchString, position) {
                var subjectString = this.toString();
                if (typeof position !== 'number' || !isFinite(position)
                    || Math.floor(position) !== position || position > subjectString.length) {
                    position = subjectString.length;
                }
                position -= searchString.length;
                var lastIndex = subjectString.indexOf(searchString, position);
                return lastIndex !== -1 && lastIndex === position;
            };
        }

		var urlParams;
        (window.onpopstate = function () {
			var match,
				pl     = /\+/g,  // Regex for replacing addition symbol with a space
				search = /([^&=]+)=?([^&]*)/g,
				decode = function (s) { return unescape(s.replace(pl, " ")); },
				query  = window.location.search.substring(1);

			urlParams = {};
			while (match = search.exec(query))
			   urlParams[decode(match[1])] = decode(match[2]);
		})();

        var invalidateAccessToken = urlParams['invalidateAccessToken'] || '';
        var domainAndUsername = urlParams['domainAndUsername'] || '';
        var assertionId = urlParams['assertionId'] || '';
        var userIdentity = urlParams['userIdentity'] || '';
		var postLogoutRedirectUri = urlParams['post_logout_redirect_uri'] || urlParams['redirect'];
		if ((postLogoutRedirectUri === undefined || postLogoutRedirectUri == "") && (document.URL != document.referrer)) {
		    postLogoutRedirectUri = document.referrer;
		}

		if (!postLogoutRedirectUri.endsWith('/')) {
		    postLogoutRedirectUri += '/';
		}

        function logoutBridge(url, federationLogoutBindingProtocol) {
            if (federationLogoutBindingProtocol === 'POST') {
                window.document.open('text/html');
                window.document.write(url);
                window.document.close();
            }
            else {
                url = url.replace(/post_logout_redirect_uri=[^&]*/, "post_logout_redirect_uri=" + postLogoutRedirectUri);

                var iframe = document.createElement('iframe');
                $(iframe).css('border', '0px');
                $(iframe).css('display', 'none');

                iframe.src = url;
                document.getElementsByTagName('body')[0].appendChild(iframe);
            }
        }

        var BIZAGI_PATH_TO_BASE = "./";
        var BIZAGI_LOCAL_RESOURCES = true;
        var BIZAGI_ENVIRONMENT =bizagiConfig.environment || 'release';
        var loader = bizagi.loader;

        loader.init(function () {
            loader.start("static-pages")
                .then(function () {
                $(document).ready(function () {
                    $.get('Api/Authentication/BizagiConfig', function () { })
                        .done(function (bizagiConfigRes) {
                            if (bizagiConfigRes) {
                                if (postLogoutRedirectUri === '/') {
                                    postLogoutRedirectUri = bizagiConfigRes.applicationUrl;
                                }

                                switch (bizagiConfigRes.authenticationType) {
                                    case 'Federate':
                                        var federationLogoutBindingProtocol = bizagiConfigRes.federationLogoutBindingProtocol;
                                        if (bizagiConfigRes.authenticationSubType === 'WSFederated') {
                                            var logoutParams = { sourceLogout: "user", userIdentity: userIdentity };
                                            $.post('Rest/Authentication/logout', logoutParams, function () { }).done(function (logoutResponse) {
                                                if (bizagiConfigRes.logOffURL) {
                                                    var url = decodeURI(bizagiConfigRes.logOffURL);
                                                    logoutBridge(url, federationLogoutBindingProtocol);
                                                }
                                            }).fail(function () {
                                                window.location.href = postLogoutRedirectUri;
                                            });
                                        }
                                        else if (bizagiConfigRes.authenticationSubType === 'Saml') {

                                            if (bizagiConfigRes.redirectToLogoffPageAfterLogoffProcess || bizagiConfigRes.redirectToLogoffPageAfterLogoffProcess == "true") {
                                                postLogoutRedirectUri = bizagiConfigRes.applicationUrl + '/post-logout.html';
                                            }

                                            var params = { assertionId: assertionId, state: 'post_logout_redirect_uri' + postLogoutRedirectUri, userIdentity: userIdentity };
                                            if (domainAndUsername) {
                                                params.domainAndUsername = domainAndUsername;
                                            }

                                            $.get('Api/Authentication/FederateLogoffUrl', params, function () { })
                                                .done(function (logOffResponse) {
                                                    if (typeof logOffResponse == 'object' && logOffResponse.federateLogoffUrl.indexOf('auth-error.html', 0) >= 0) {
                                                        var params = { sourceLogout: "user", invalidateAccessToken: invalidateAccessToken };
                                                        $.get('oauth2/server/logout', params, function () { })
                                                            .done(function (response) {
                                                                var json = response;
                                                                if (typeof response != 'object') {
                                                                    try {
                                                                        json = JSON.parse(response);
                                                                    } catch (e) {
                                                                        json = { assertionId: '' };
                                                                    }
                                                                }

                                                                if (!assertionId || assertionId === '') {
                                                                    assertionId = json.assertionId;
                                                                }

                                                                params.assertionId = assertionId;
                                                                $.get('Api/Authentication/FederateLogoffUrl', params, function () { })
                                                                    .done(function (logOffResponse) {
                                                                        if (typeof logOffResponse == 'object' && logOffResponse.federateLogoffUrl.indexOf('auth-error.html', 0) >= 0) {
                                                                            window.location.href = postLogoutRedirectUri;
                                                                        }
                                                                        else {
                                                                            var url = decodeURI(logOffResponse.federateLogoffUrl);
                                                                            logoutBridge(url, federationLogoutBindingProtocol);
                                                                        }
                                                                    });
                                                            });
                                                    }
                                                    else {
                                                        var logoutParams = { sourceLogout: "user", userIdentity: userIdentity };
                                                        $.post('Rest/Authentication/logout', logoutParams, function () { }).done(function (logoutResponse) {
                                                            var url = decodeURI(logOffResponse.federateLogoffUrl);
                                                            logoutBridge(url, federationLogoutBindingProtocol);
                                                        }).fail(function () {
                                                            window.location.href = postLogoutRedirectUri;
                                                        });
                                                    }
                                                });
                                        }
                                        break;
                                    case 'OAuth2':
                                        var logoutParams = { sourceLogout: "user", userIdentity: userIdentity };
                                        $.post('Rest/Authentication/logout', logoutParams, function () { }).done(function (logoutResponse) {
                                            var params = { sourceLogout: "user", invalidateAccessToken: invalidateAccessToken, userIdentity: userIdentity };
                                            $.get('oauth2/server/logout', params, function () { })
                                                .done(function (response) {
                                                    var json = response;
                                                    if (typeof response != 'object') {
                                                        try {
                                                            json = JSON.parse(response);
                                                        } catch (e) {
                                                            json = { assertionId: '' };
                                                        }
                                                    }

                                                    if (!assertionId || assertionId === '') {
                                                        assertionId = json.assertionId;
                                                    }

                                                    $.get('Api/Authentication/OAuth2/OAuth2AuthenticationConfig').done(function (oauthbizagiConfig) {
                                                        if (oauthbizagiConfig.logoutUrl && oauthbizagiConfig.logoutUrl != "") {

                                                            var url = oauthbizagiConfig.logoutUrl;

                                                            if (!oauthbizagiConfig.redirectToLogoffPageAfterLogoffProcess || oauthbizagiConfig.redirectToLogoffPageAfterLogoffProcess != "true") {
                                                                url = url.replace(/post_logout_redirect_uri=[^&]*/, "post_logout_redirect_uri=" + postLogoutRedirectUri);
                                                            }

                                                            if (url.indexOf("domainAndUsername") === -1 && domainAndUsername) {
                                                                url += '&domainAndUsername=' + domainAndUsername;
                                                            }

                                                            if (assertionId && url.indexOf("assertionId") === -1) {
                                                                url += '&assertionId=' + assertionId;
                                                            }

                                                            if (logoutResponse.invalidateAccessToken) {
                                                                url = url.replace(/invalidateAccessToken=[^&]*/, "invalidateAccessToken=" + logoutResponse.invalidateAccessToken);
                                                            }

                                                            if (logoutResponse.idTokenHint && url.indexOf("id_token_hint") >= 0) {
                                                                url = url.replace(/id_token_hint=[^&]*/, "id_token_hint=" + logoutResponse.idTokenHint);
                                                            }

                                                            window.location.href = url;
                                                        }
                                                        else {
                                                            window.location.href = postLogoutRedirectUri;
                                                        }
                                                    }).fail(function () {

                                                    });
                                                });
                                        }).fail(function () {
                                            window.location.href = postLogoutRedirectUri;
                                        });
                                            break;
                                    case 'Windows':
                                    case 'Custom':
                                    case 'BizAgi':
                                    case 'Mixed':
                                        var logoutParams = { sourceLogout: "user", userIdentity: userIdentity };
                                        $.post('Rest/Authentication/logout', logoutParams, function () { }).done(function (logoutResponse) {
                                            window.location.href = postLogoutRedirectUri;
                                        }).fail(function () {
                                            window.location.href = postLogoutRedirectUri;
                                        });
                                        break;
                                    default:
                                        window.location.href = postLogoutRedirectUri;
                                        break;
                                }
                            }

                            $('#linkUrlHome').attr('href', postLogoutRedirectUri);
                            $('#linkUrl').attr('href', postLogoutRedirectUri);
                        });
                    });
                });
        });
    </script>

    <div id="content" class="main-content">
        <a id="linkUrlHome" href="#" style="color:#FFFFFF;">
            <h1 class="logo-suite">bizagi suite</h1>
        </a>
        <p class="txt">You should be logged-out in no time.</p>
        <p class="txt">If it's taking too long, then please <a id="linkUrl" href="#">click here.</a></p>
    </div>
</body>
</html>