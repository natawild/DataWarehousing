bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.plan",{},{init:function(e,t,i,a){var s=this;s.params=a||{},s.projectDashboard=i,s._super(e,t,a),s.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.plan").concat("#project-dashboard-menu")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.clean();var a=i.getContent().empty(),s=i.getTemplate("project-dashboard-menu");i.params.menuPlanDashboard=i.params.menuPlanDashboard||{},$.extend(i.params.menuPlanDashboard,i.params.menuDashboard),i.planState=i.getPlanState(i.params.plan,i.params.planChild);var n={planState:i.planState,showCommentsOptionMenu:i.params.menuPlanDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuPlanDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuPlanDashboard.showTimeLineOptionMenu&&i.isVisibleShowTimeLine(i.planState)};s.render(n).appendTo(a),$("li[data-context='"+i.params.showContextByMenuDashboard.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active"),i.handlerEvents()},getPlanState:function(e,t){var i;return t&&t.currentState?i=t.currentState:e&&e.currentState&&(i=e.currentState),i},isVisibleShowTimeLine:function(e){var t=!0;return"PENDING"===e&&(t=!1),t},loadContentById:function(e){var t=this;e.preventDefault();var i=$(e.target).closest("li");if("PLANBACK"===i.data("context"))t.backParentPlan();else if(!i.hasClass("active")){var a=i.data("context");a&&(t.pub("notify",{type:a.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:a})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active"))}},subMenuHandler:function(){var e=this,t=e.getContent(),i=$("[data-context='PLANCOMMENTS']",t),a=$("[data-context='PLANFILES']",t),s=$("[data-context='PLANTIMELINE']",t);$(".ui-bizagi-wp-project-tab-submenu a",t).on("click",function(){i.toggle(),a.toggle(),e.isVisibleShowTimeLine(e.planState)&&s.toggle()})},backParentPlan:function(){var e=this,t=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),i=parseInt(t[0]),a=e.projectDashboard.getParamsByBackFromPlan(e.params,i);e.pub("notify",{type:a.typeContext,args:$.extend(e.params,a.paramsNotify)})},handlerEvents:function(){var e=this,t=e.getContent();e.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(e.loadContentById,e))},clean:function(){var e=this,t=e.getContent();$(".ui-bizagi-wp-project-tab-links a",t).off(),e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.plan",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard",bizagi.workportal.widgets.project.dashboard.menu.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var e=this,t=e.getTemplate("project-content-dashboard");return e.content=t.render({}),e.content},postRender:function(){setTimeout(function(){$(window).trigger("resize")},1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),function(e){var t=window.kendo.ui,i=t.Widget,a=i.extend({init:function(e,t){var a=this;i.fn.init.call(a,e,t),a._maxFilesSize=t.maxSize,a._fileList=[],a._onlyValidateServerFileExtension=t.onlyValidateServerFileExtension||!0,a._supportFileExt=t.extensions,a._uploadMaxFilesSize=t.maxSize,a.upload=a._initUpload(),a.loadNotifier=a._initLoadNotifier(),a.notification=a._initNotification(),a._eventsHandler(),a._initLocalization(a.options.localization)},options:{name:"ProjectAttachments",wrapper:e('<div class="project-attachments"></div>'),multiple:!0,dropZone:!0,maxFilesSize:bizagi.currentUser?bizagi.currentUser.uploadMaxFileSize:25e3,enabled:!0,localization:{}},_initUpload:function(){var e=this,t=e.options,i=t.localization||{},a=0;return e._initLocalization(i),this.element.kendoUpload({async:{saveUrl:t.saveUrl+"?xsrf="+bizagi.cookie(".BIZCSRF"),autoUpload:!0},select:function(t){e._filterMaxFilesSize(t),a=0},complete:function(){var t=setInterval(function(){0===e.loadNotifier.wrapper.find("li.k-file-progress").length&&(e._showNotificationCompleteUpload(e.loadNotifier.wrapper,a),clearInterval(t))},300)},upload:t.upload,progress:function(t){e._onProgressFile(t)},success:function(i){e._fileList.push(i.files[0]),a+=1,t.success(i)},error:function(t){e.onErrorFile(t)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:t.multiple,enabled:t.enabled,dropZone:t.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return e("<div></div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var e=this.options.localization;return this.options.wrapper.kendoWindow({title:e.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(t){var i={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error-type"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",Math.round(this._maxFilesSize/1e6,-1)),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};e.extend(t,i)},_onProgressFile:function(t){var i=this._getFileItemByUID(t.files[0].uid),a=t.percentComplete;e(".k-progress",i).css({width:a+"%"}),e(".k-upload-pct",i).removeClass("k-icon k-loading").text(a+"%"),100===a&&e(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(e){var t=e.files,i=this.options.template;this.loadNotifier.content(i.render({files:t})),this.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"}),this.loadNotifier.open()},_showNotificationCompleteUpload:function(e,t){e.find("li.k-file-success").length===t&&0===e.find("li.k-file-error").length&&this._autoHideMessage(e)},_autoHideMessage:function(e){var t=this;setTimeout(function(){e.fadeOut(function(){t.loadNotifier.close()})},2e3)},_onCancelFile:function(e){var t=e.closest("li"),i=this.upload.wrapper,a=t.data("guid");i.find("li[data-uid="+a+"] .k-upload-action").trigger("click"),t.remove()},_onRemoveFile:function(e){e.closest("li").remove()},_onRetryFile:function(t){var i=t.closest("li").data("guid"),a=e.grep(this._fileList,function(e){return e.uid===i});this.options.retry(a[0])},onErrorFile:function(e){var t=this.options.localization,i=e.files[0],a=this._isValidFile(i),s=""!==a.message?a.message:t.errorUpload;this.setStatus("ERROR",i.uid,s)},_isValidFile:function(t){var i=this.options.localization,a=!0,s="";return(t.size>this._uploadMaxFilesSize||null==t.size||0==t.size)&&(s=i.errorSize,a=!1),this._onlyValidateServerFileExtension||-1===e.inArray(t.extension,this._supportFileExt)&&(s=i.errorSecurity,a=!1),{valid:a,message:s}},_filterMaxFilesSize:function(e){for(var t=0,i=0,a=e.files.length;i<a;i++)t+=e.files[i].size;t>this._maxFilesSize?(this._notifySizeExceeded(),e.preventDefault()):this._onShowUploadNotifier(e)},_notifySizeExceeded:function(){this.notification.show(this.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(t){return e("li[data-guid="+t+"]",this.loadNotifier.element)},_switchEvents:function(t){var i=e(".k-icon",t.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?this._onRemoveFile(i):i.hasClass("k-retry")?this._onRetryFile(i):i.hasClass("k-cancel")&&this._onCancelFile(i)},_eventsHandler:function(){var e=this;e.loadNotifier.element.on("click","button.k-upload-action",function(t){e._switchEvents(t)})},cancelFilesUpload:function(){this.upload.wrapper.find("li .k-upload-action").trigger("click"),this.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy(),this.upload.destroy()},setStatus:function(t,i,a){var s=this._getFileItemByUID(i),n=this.options.localization;switch(t){case"SUCCESS":s.removeClass("k-file-progress k-file-error").addClass("k-file-success"),e(".k-upload-action .k-icon",s).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",n.close).show(),e(".k-errormsg",s).text("");break;case"ERROR":s.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-action .k-icon",s).removeClass("k-i-refresh k-retry").addClass("k-remove").show(),e(".k-upload-status .k-upload-pct",s).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning"),e(".k-errormsg",s).text(a).prop("title",a);break;case"RETRY":s.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-status .k-upload-pct",s).removeClass("k-upload-pct k-loading").addClass("k-warning").text(""),e(".k-upload-action .k-icon",s).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",n.retry).show(),e(".k-errormsg",s).text(n.errorUpload).prop("title",n.errorUploadiis)}}});t.plugin(a)}(jQuery),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.discussions",{},{init:function(e,t,i,a){var s=this;s.typeResource="DiscussionGuid",s.plugins={},s.dialogBoxDiscussion={},s.attchComments={},s.attchDiscussions={remove:[],addition:[]},s.listDataDiscussion=[],s.userPictures=[],s.commentsList={},s.globalTags=[],s.tempTagsBeforeDelete=[],s.tempTagsToDelete=[],s.keySentenceAddTag=bizagi.localization.getResource("workportal-project-discussion-add-new-tag")+": ",s.notifier=i,s._super(e,t,a),s.loadTemplates({"project-discussions":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-wrapper"),"project-discussions-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-popup-wrapper"),"project-discussions-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-list-wrapper"),"project-discussions-comments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-comments-list"),"project-discussions-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-attachments-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var e=this.getTemplate("project-discussions");return this.content=e.render({}),this.content},postRender:function(){var e=this,t=e.getContent();e.plugins.popupDiscussion=e.initPluginPopupDiscussion();var i=e.plugins.popupDiscussion;e.form={buttonShowFormNewDiscussion:$(".ui-bizagi-wp-action-new",t),title:$(".ui-bizagi-wp-project-popupform-h4",i),subject:$("#ui-bizagi-wp-project-discussions-popup-subject-input",i),description:$("#ui-bizagi-wp-project-discussions-popup-description-textarea",i),buttonShowPopupDiscussionToAdd:$("#ui-bizagi-wp-project-discussions-button-action-show-popup-to-add",t),buttonAddDiscussion:$("#ui-bizagi-wp-project-discussions-popup-action-add-discussion",i),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",i),formDiscussion:$(".ui-bizagi-wp-project-discussions-popup",i),attachments:$(".ui-bizagi-wp-project-discussions-attachments-cmnwrapper",i),edition:!1},e.plugins.tagsFilter=e.initPluginTagsFilter(),e.plugins.tagsMultiSelect=e.initPluginTagsMultiSelect(i),e.getDiscussions(),e.eventsHandler(),e.restrictedEventsHandler()},getDiscussions:function(){var e=this;e.getDataDiscussions().done(function(){var t=$.map(e.listDataDiscussion,function(e){return e.user}),i=$.map(e.commentsList,function(e){return $.map(e.comments,function(e){return e.user})});var a=function(e){for(var t={},i=[],a=e.length,s=0,n=0;n<a;n++){var o=e[n];1!==t[o]&&(t[o]=1,i[s++]=o)}return i}(t.concat(i).concat(bizagi.currentUser.idUser)).join(",");e.getDataUsers(a).then(function(){e.renderUserProfilesAndImages()}),e.setClassesTagsByDiscussion()})},onNotifyOpenPopup:function(){this.form.edition=!1,this.showFormAddDiscussion("workportal-project-discussion-adddiscussion"),this.renderUserProfile()},initPluginPopupDiscussion:function(){var e=this.getTemplate("project-discussions-popup");return this.dialogBoxDiscussion.formContent=e.render({attachments:[]}),this.dialogBoxDiscussion.formContent},initPluginTagsMultiSelect:function(e){var t,i=this,a=e.find("#ui-bizagi-wp-project-discussions-options-multiselect-tags"),s=!1,n=!1;return a.kendoMultiSelect({change:function(){var e=this.value().slice(0),t=this.dataSource.data();e.length>0&&-1!==t[0].tag.replace(i.keySentenceAddTag,"").indexOf(e[e.length-1])&&(e[e.length-1]=t[0].tag.replace(i.keySentenceAddTag,"")),e=(e=e.filter(Boolean)).filter(function(e,t,i){return i.indexOf(e)===t});var a="";if(t.length>0&&-1!==t[0].tag.indexOf(i.keySentenceAddTag)){a=t[0].tag.replace(i.keySentenceAddTag,"");var o={};-1!==e.indexOf(a)?(o=this.dataSource.at(0),s=!0,this.dataSource.remove(o),s=!1,this.refresh(),n=!0):a&&($("li:first",this.list).hasClass("k-state-focused")&&(n=!0,e.push(a)),o=this.dataSource.at(0),s=!0,this.dataSource.remove(o),s=!1)}a&&(n&&(0===this.dataSource.data().filter(function(e){return e.tag===a}).length&&this.dataSource.add({guid:a,tag:a}),n=!1));this.dataSource.filter({}),this.value(e)},dataBound:function(){if((t||this._prev)&&t!==this._prev&&!s){t=this._prev;var e=this.dataSource.data(),a=!1;e.length>0&&-1!==e[0].tag.indexOf(i.keySentenceAddTag)&&(e[0].tag=i.keySentenceAddTag+t,this.refresh(),a=!0,$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused")),a||this.dataSource.insert(0,{tag:i.keySentenceAddTag+t,guid:t}),0==this.dataSource.total()&&(this.search(),this.open(),this.refresh(),$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"))}},dataSource:[],dataTextField:"tag",dataValueField:"guid",filter:"contains",animation:!1}).data("kendoMultiSelect")},initPluginTagsFilter:function(){var e=this,t=e.getContent();return $("#ui-bizagi-wp-project-discussions-options-tags-filter",t).kendoMultiSelect({change:function(){e.hideOrShowDiscussionsByFilter()},autoClose:!1,tagMode:"single",dataTextField:"tag",dataValueField:"guid"}).data("kendoMultiSelect")},hideOrShowDiscussionsByFilter:function(){var e=this,t=e.plugins.tagsFilter.value();t.length>0?($(".ui-bizagi-wp-project-discussions-item",e.getContent()).hide(),t.forEach(function(t){$(".ui-bizagi-wp-project-discussions-item."+t,e.getContent()).show()})):$(".ui-bizagi-wp-project-discussions-item",e.getContent()).show()},validateAddCommentForm:function(e){var t=!1,i=$("textarea",e);if(""===i.val().trim()){var a=bizagi.localization.getResource("workportal-project-discussion-requiredcomment");i.parent().next().find("span").html(a)}else i.parent().next().find("span").empty(),t=!0;return t},validateAddDiscussionForm:function(e){var t=!1,i=$("#ui-bizagi-wp-project-discussions-popup-subject-input",e),a=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e);if(""!==i.val().trim()&&""!==a.val().trim()&&(t=!0),""===i.val().trim()){var s=bizagi.localization.getResource("workportal-project-discussion-subjectrequired");i.parent().find("span").html(s)}else i.parent().find("span").empty();if(""===a.val().trim()){var n=bizagi.localization.getResource("workportal-project-discussion-requireddescription");a.parent().next().find("span").html(n)}else a.parent().next().find("span").empty();return t},applyFileAttachments:function(e){var t=this,i="DISCUSSIONS"===e?t.plugins.popupDiscussion:t.getContent();return $(".ui-bizagi-wp-project-discussions-attachment-upload",i).kendoProjectAttachments({saveUrl:t.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:t.getTemplate("project-attachments"),success:function(i){t.onSuccessFile(i,e)},upload:$.proxy(t.addFileData,t),dropZone:!1,extensions:t.supportFileExt,maxSize:t.uploadMaxFilesSize}).data("kendoProjectAttachments")},addFileData:function(e){var t=e.files[0].uid;e.files[0].guid=t,e.data={guid:t}},getDataDiscussions:function(){var e=this,t=$.Deferred(),i={globalParent:e.radNumber,typeResource:e.typeResource};return"FLOW-DECONTEXTUALIZED-PLANS"===e.params.flowContext&&(i.globalParent=e.params.plan.id),e.dataService.getDiscussionsData(i).pipe(function(t){return e.callForListComments(t)}).done(function(i){e.listDataDiscussion=e.sortDiscussions(i),e.updateTemplateListDiscussion(),t.resolve()}),t.promise()},getDataUsers:function(e){var t=this,i=$.Deferred(),a={usersGuids:e,width:50,height:50};return a.usersGuids?t.dataService.getUsersData(a).always(function(e){t.userPictures=function(e){for(var t=e.concat(),i=0;i<t.length;++i)for(var a=i+1;a<t.length;++a)t[i]===t[a]&&t.splice(a--,1);return t}(t.userPictures.concat(e)),i.resolve()}):i.resolve(),i.promise()},callForListComments:function(e){for(var t=this,i=$.Deferred(),a=[],s=0,n=e.length-1;s<=n;s++){t.addGlobalTags(e[s].tags,!1);var o={idParent:e[s].guid,dateTime:t.getDateServer(),count:6};t.commentsList[o.idParent]={comments:[],count:0,total:0};var r=$.when(t.dataService.getCommentsData(o)).done(function(e){e.length>0&&(t.commentsList[e[0].parent]={comments:e,count:e.length,total:0})});a.push(r)}return $.when.apply($,a).done(function(){i.resolve(e)}),i.promise()},sortDiscussions:function(e){var t=[];return e.length&&(t=e.sort(function(e,t){var i=e.date;return t.date-i})).length>0&&t.unshift(t.pop()),t},resetDiscussionAttachments:function(){var e=this,t=e.plugins.popupDiscussion;$(".ui-bizagi-wp-project-attachments-list",t).empty(),e.plugins.tagsMultiSelect.value([]),e.attchDiscussions.addition=[],e.attchDiscussions.remove=[],e.getDiscussions()},sendDataUpdateDiscussion:function(e){var t=this,i=t.prepareFilesToSave();t.form.buttonAddDiscussion.prop("disabled",!0);var a=t.getTagsDiscussionBySave(),s=t.getGuidsTagsDiscussionToDelete(),n={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:e,tags:a,typeResource:"DiscussionGuid",general:!1,date:t.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};t.plugins.attchDiscussions.close(),t.dataService.editDiscussion(n).always(function(i){if(200===i.status||201===i.status||void 0===i.status){t.addGlobalTags(a,!0);var o=t.getDiscussionDataByGUID(e);o.name=n.content.name,o.description=n.content.description,o.attachments=n.content.attachments,o.tags=n.content.tags,t.onClosePopupDiscussion(),t.resetDiscussionAttachments(),t.updateTemplateListDiscussion(),t.removeGlobalTags(s),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-edited"),""))}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-edition"),""));t.renderUserProfilesAndImages(),t.setClassesTagsByDiscussion(),t.hideOrShowDiscussionsByFilter()})},validateStringIsGuid:function(e){return/^({|()?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}(}|))?$/.test(e)&&!/^({|()?0{8}-(0{4}-){3}0{12}(}|))?$/.test(e)},sendDataInsertDiscussion:function(e){var t=this,i=t.prepareFilesToSave();t.form.buttonAddDiscussion.prop("disabled",!0);var a=t.getTagsDiscussionBySave(),s={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:e,tags:a,typeResource:"DiscussionGuid",general:!1,date:t.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};t.plugins.attchDiscussions.close(),t.dataService.postDiscussion(s).always(function(e){if(200===e.status||201===e.status||void 0===e.status){t.addGlobalTags(a,!0),t.form.buttonAddDiscussion.prop("disabled",!1);var i={name:s.content.name,description:s.content.description,date:s.content.date,user:s.content.user,attachments:s.content.attachments,radNumber:s.content.globalParent,general:s.content.general,guid:s.content.guid,tags:s.content.tags,typeResource:s.content.typeResource};t.commentsList[s.content.guid]={comments:[],count:0,total:0},0===t.listDataDiscussion.length?t.listDataDiscussion.push(i):t.listDataDiscussion.splice(1,0,i),t.resetDiscussionAttachments(),t.onClosePopupDiscussion(),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-created"),"")),t.updateTemplateListDiscussion()}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-creation"),""));t.renderUserProfilesAndImages(),t.setClassesTagsByDiscussion(),t.hideOrShowDiscussionsByFilter()})},getTagsDiscussionBySave:function(){var e=this,t=e.plugins.tagsMultiSelect.value(),i=e.plugins.tagsMultiSelect.dataSource.data(),a=[];return t.forEach(function(t){var s,n=e.validateStringIsGuid(t);1===(s=n?i.filter(function(e){return e.guid===t}):i.filter(function(i){var a=e.validateStringIsGuid(i.guid);return i.tag===t&&!a})).length&&a.push({guid:n?s[0].guid:s[0].uid,tag:s[0].tag})}),a},differenceArrays:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},getGuidsTagsDiscussionToDelete:function(){var e=this.plugins.tagsMultiSelect.value();return this.differenceArrays(this.tempTagsBeforeDelete,e)},setStateUIShowMoreComments:function(e,t){var i=e.siblings(".ui-bizagi-wp-project-discussion-showmore-comments"),a=i.find(".ui-bizagi-wp-project-discussion-showmore-comments-button"),s=i.find(".ui-bizagi-wp-project-discussion-showmore-no-more-comments"),n=i.find(".ui-bizagi-wp-project-discussion-showmore-loading-comments");"ALLOW_MORE_COMMENTS"===t&&(a.show(),s.hide(),n.hide()),"LOADING_MORE_COMMENTS"===t&&(a.hide(),s.hide(),n.show()),"NO_MORE_COMMENTS"===t&&(a.hide(),s.show(),n.hide())},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},addGlobalTags:function(e,t){for(var i=this,a=0;a<e.length;a+=1){0===i.globalTags.filter(function(t){return t.tag===e[a].tag}).length&&(e[a].globalParent=i.radNumber,i.globalTags.push(e[a]),t&&i.dataService.postTag(e[a]))}i.plugins.tagsFilter.dataSource.data(i.globalTags),i.plugins.tagsMultiSelect.dataSource.data(i.globalTags)},removeGlobalTags:function(e){var t=this,i=$.map(t.listDataDiscussion,function(e){return $.map(e.tags,function(e){return e.guid})}).concat(e),a=[];e.forEach(function(e){1===i.filter(function(t){return t===e}).length&&a.push(e)}),a.forEach(function(e){var i={idTag:e};t.dataService.deleteTag(i);for(var a=t.globalTags.length-1;a>=0;a-=1)t.globalTags[a].guid===e&&t.globalTags.splice(a,1)}),t.plugins.tagsFilter.dataSource.data(t.globalTags),t.plugins.tagsMultiSelect.dataSource.data(t.globalTags)},setClassesTagsByDiscussion:function(){for(var e=0;e<this.listDataDiscussion.length;e+=1){var t=$.map(this.listDataDiscussion[e].tags,function(e){return e.guid}).join(" ");$(".ui-bizagi-wp-project-discussions-item[data-guid='"+this.listDataDiscussion[e].guid+"']",this.getContent()).addClass(t)}},updateTemplateListDiscussion:function(){for(var e=this,t=e.getContent(),i=e.getTemplate("project-discussions-list"),a=e.getCurrentUserInfo(),s=i.render({listDataDiscussions:e.listDataDiscussion,user:a,isOpen:!bizagi.util.parseBoolean(e.params.isClosedForAllUsers),returnServedCommentByParentId:function(t){return e.returnServedCommentByParentId(t)}}),n=0;n<this.listDataDiscussion.length;n++)this.mapTempComments($("#ui-bizagi-wp-project-discussions-list-wrapper",t).find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[n].guid+"]"),s.find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[n].guid+"]"));$("#ui-bizagi-wp-project-discussions-list-wrapper",t).empty().append(s),e.plugins.attchComments=e.applyFileAttachments("COMMENTS")},showFormAddDiscussion:function(e){var t=this;t.plugins.attchComments&&t.plugins.attchComments.close(),t.dialogBoxDiscussion.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,zIndex:1,title:bizagi.localization.getResource(e),maximize:!0,open:$.proxy(t.onOpenPopupDiscussion,t),close:function(){t.resetDiscussionAttachments(),t.onClosePopupDiscussion()}})},resetFormDiscussion:function(){var e=this;e.form.buttonAddDiscussion.prop("disabled",!1),e.form.subject.val(""),e.form.description.val("");var t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",e.dialogBoxDiscussion.formContent),i=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e.dialogBoxDiscussion.formContent);t.parent().find("span").empty(),i.parent().next().find("span").empty()},renderUserProfile:function(){var e=$.grep(this.userPictures,function(e){return e.id===bizagi.currentUser.idUser})[0],t=$(".ui-bizagi-wp-project-popupform-user"),i=t.find(".bz-wp-avatar-img"),a=t.find(".bz-wp-avatar-label");e&&(e.picture?i.attr("src","data:image/png;base64,"+e.picture):(i.hide(),a.html(e.name.getInitials()).show()))},renderUserProfilesAndImages:function(){var e=this,t=$.grep(e.userPictures,function(e){return e.id===bizagi.currentUser.idUser})[0],i="data:image/png;base64,";t&&($(".ui-bizagi-wp-project-discussions-create-comment .bz-wp-discussion-username").html(t.name),t.picture?($(".ui-bizagi-wp-project-discussions-item-user img").attr("src",i+t.picture),$(".ui-bizagi-wp-project-popupform-image-current-user").attr("src",i+t.picture)):($(".ui-bizagi-wp-project-discussions-item-user label.bz-wp-avatar-label").html(t.name.getInitials()).show(),$(".ui-bizagi-wp-project-discussions-item-user img").hide()));for(var a=0;a<e.userPictures.length;a++)$("div[data-iduser='"+e.userPictures[a].id+"'] .bz-wp-discussion-username").html(e.userPictures[a].name),e.userPictures[a].picture?$("div[data-iduser='"+e.userPictures[a].id+"'] .bz-wp-avatar-img").attr("src",i+e.userPictures[a].picture):($("div[data-iduser='"+e.userPictures[a].id+"'] .bz-wp-avatar-img").hide(),$("div[data-iduser='"+e.userPictures[a].id+"'] label.bz-wp-avatar-label").html(e.userPictures[a].name.getInitials()))},switchCommentsEvents:function(e){var t=this,i=$(e.target),a=i.parent();if(i.is("textarea"))t.onShowButtonsPanel(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-cancel"))t.onCancelComment(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-share")){var s=i.closest(".ui-bizagi-wp-project-discussions-add-comment");if(t.validateAddCommentForm(s)){var n=Math.guid();t.onCreateComment(i,n)}}else i.hasClass("ui-bizagi-wp-project-discussions-comment-view")?t.onViewComment(i):i.hasClass("ui-bizagi-wp-project-discussion-showmore-comments-button")?t.onViewMoreComments(i):i.hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?t.onRemoveFiles(i):a.hasClass("biz-wp-user-icon-admin")&&a.hasClass("biz-wp-action-edit-discussion")?t.onEditDiscussion(i):a.hasClass("ui-bizagi-wp-project-discussion-delete")?$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-discussion-querydelete"),"","info")).done(function(){t.onDeleteComment(a)}):a.hasClass("bz-bizagi-wp-project-discussions-attachment-itemwrapper")&&t.onDownloadAttachment(i.closest("li"));e.stopPropagation()},onEditDiscussion:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-item").data("guid");this.setDiscussionsDataByGUID(t),this.showFormAddDiscussion("workportal-project-discussion-edit")},setDiscussionsDataByGUID:function(e){var t=this,i=t.getDiscussionDataByGUID(e),a=$(".ui-bizagi-wp-project-attachments-list",t.form.attachments);t.form.edition={guid:e},t.attchDiscussions={addition:i.attachments,remove:[]},t.form.title.text(bizagi.localization.getResource("workportal-project-discussion-edit")),t.form.subject.val(i.name),t.form.description.val(i.description);var s=$.map(i.tags,function(e){return e.guid});t.plugins.tagsMultiSelect.value(s),t.tempTagsBeforeDelete=[],t.tempTagsBeforeDelete=t.tempTagsBeforeDelete.concat(t.plugins.tagsMultiSelect.value()),t.renderAttachments(i.attachments,"DISCUSSIONS",a)},getDiscussionDataByGUID:function(e){for(var t,i=this.listDataDiscussion.length-1;i>=0;i--)this.listDataDiscussion[i].guid===e&&(t=this.listDataDiscussion[i],i=0);return t},onViewComment:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-comment-truncatewrapper");t.toggleClass("ui-bizagi-wp-project-discussions-comment-shortcomment"),t.toggleClass("ui-bizagi-wp-project-discussions-comment-longcomment")},onViewMoreComments:function(e){var t=this,i=e.closest(".ui-bizagi-wp-project-discussion-showmore-comments").siblings(".ui-bizagi-wp-project-discussion-comment-list"),a=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid");t.commentsList[a].total?t.getMoreComments(a,i):t.dataService.getCommentsCountByParent(a).done(function(e){t.commentsList[a].total=e.count,t.getMoreComments(a,i)})},getMoreComments:function(e,t){var i,a=this;a.commentsList[e].total>a.commentsList[e].comments.length?(a.setStateUIShowMoreComments(t,"LOADING_MORE_COMMENTS"),i=0===a.commentsList[e].comments.length?a.getDateServer():a.commentsList[e].comments[a.commentsList[e].comments.length-1].date,i-=1,a.dataService.getCommentsData({dateTime:i,idParent:e,count:6}).done(function(i){if(i.length){Array.prototype.push.apply(a.commentsList[e].comments,i),a.commentsList[e].count+=i.length,a.renderCommentByDiscussion(t,e,i),a.renderUserProfilesAndImages(),i.length>5?a.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS"):a.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS");var s=$.map(a.userPictures,function(e){return e.id}),n=$.map(a.commentsList,function(e){return $.map(e.comments,function(e){return e.user})}),o=$(n).not(s).get().join(",");a.getDataUsers(o).then(function(){a.renderUserProfilesAndImages()})}else a.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")}).fail(function(){a.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS")})):a.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")},renderCommentByDiscussion:function(e,t,i){var a,s=this.getTemplate("project-discussions-comments"),n={comments:[],user:this.getCurrentUserInfo(),isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)};i.length?(n.comments=i,a=s.render(n),e.append(a)):(n.comments=this.commentsList[t].comments,a=s.render(n),e.html(a))},getCommentByGuid:function(e,t){for(var i=this.commentsList[e].comments,a=0,s=i.length;a<s;a++)if(i[a].guid===t){for(var n=[],o=0,r=i[a].attachments.length;o<r;o++)n.push(i[a].attachments[o].guid);return{attachments:n,index:a}}return{}},returnServedCommentByParentId:function(e){if(void 0!==this.commentsList[e])return this.commentsList[e]},onShowButtonsPanel:function(e){e.closest(".ui-bizagi-wp-project-discussions-add-comment").find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper").show()},onRemoveFiles:function(e){var t,i,a,s=e.closest("li"),n=s.closest(".ui-bizagi-wp-project-attachments-list").data("type"),o=s.data("fileguid");if("COMMENT"===n){var r=s.closest(".ui-bizagi-wp-project-discussions-add-comment").data("guid");t=this.attchComments[r].addition,i=this.attchComments[r].remove}else t=this.attchDiscussions.addition,i=this.attchDiscussions.remove;for(var c=0,p=t.length-1;c<=p;c++)t[c].guid===o&&(a=t.splice(c,1),i.push(a[0].guid),c=p);s.remove()},onDeleteComment:function(e){var t=this,i=e.closest(".ui-bizagi-wp-project-discussions-item-comment"),a=i.data("cmmtguid"),s=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid"),n=t.getCommentByGuid(s,a),o={content:{guid:a},attachmentsToDelete:n.attachments};$.when(t.dataService.deleteComment(o)).always(function(e){200===e.status||void 0===e.status?(t.commentsList[s].comments.splice(n.index,1),i.remove()):t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-errordelete"),""))})},onSuccessFile:function(e,t){var i=this,a=e.files;if((e.XMLHttpRequest.response?JSON.parse(e.XMLHttpRequest.response):{}).error)"DISCUSSIONS"===t?i.plugins.attchDiscussions.onErrorFile(e):i.plugins.attchComments.onErrorFile(e);else{var s=$(e.sender.element).closest(".ui-bizagi-wp-project-discussion-textwrapper"),n=s.find(".ui-bizagi-wp-project-attachments-list");if("DISCUSSIONS"===t)i.plugins.attchDiscussions.setStatus("SUCCESS",a[0].guid),Array.prototype.push.apply(i.attchDiscussions.addition,a);else{i.plugins.attchComments.setStatus("SUCCESS",a[0].guid);var o=s.data("guid");i.attchComments[o]?Array.prototype.push.apply(i.attchComments[o].addition,a):i.attchComments[o]={addition:a,remove:[]},i.onShowButtonsPanel(n.parent())}i.renderAttachments(a,t,n)}},onDownloadAttachment:function(e){var t=e.data("fileguid");if(""!==t){var i=e.find(".bz-bizagi-wp-project-discussions-attachment-filename").text();this.dataService.getDownloadAttachment(t,i)}},onCancelComment:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-add-comment"),i=t.find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),a=t.find("textarea"),s=t.find(".ui-bizagi-wp-project-discussions-add-attachments form"),n=t.find(".k-tooltip-validation"),o=t.find(".ui-bizagi-wp-project-attachments-list"),r=t.data("guid");this.attchComments[r]={addition:[],remove:[]},this.plugins.attchComments.cancelFilesUpload(),s[0].reset(),o.empty(),a.val(""),n.hide(),i.hide()},onCreateComment:function(e,t){var i=this,a=e.closest(".ui-bizagi-wp-project-discussions-item-comment"),s=e.closest(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),n=e.closest(".ui-bizagi-wp-project-discussions-add-comment"),o=n.find("textarea"),r=n.find(".ui-bizagi-wp-project-attachments-list"),c=n.data("guid"),p=i.prepareFilesToSave("COMMENTS",c),u={content:{guid:t,attachments:p.attachments,text:o.val(),parent:c,date:i.getDateServer(),user:bizagi.currentUser.idUser},attachmentsToCreate:p.attachmentsToCreate,attachmentsToDelete:p.attachmentsToDelete};$.when(i.dataService.postComment(u)).always(function(e){if(200===e.status||201===e.status||void 0===e.status){var t=a.siblings(".ui-bizagi-wp-project-discussion-comment-list"),n={user:u.content.user,attachments:u.content.attachments,text:u.content.text,guid:u.content.guid,parent:u.content.parent,date:u.content.date};i.attchComments[u.content.parent]={addition:[],remove:[]},o.val(""),r.empty(),s.hide(),i.commentsList[n.parent].comments.unshift(n),i.renderCommentByDiscussion(t,n.parent,[]),i.plugins.attchComments.close(),i.renderUserProfilesAndImages()}})},renderAttachments:function(e,t,i){var a=this.getTemplate("project-discussions-attachments").render({attachments:e,type:t});i.append(a),bizagi.util.isIE()&&$(".ui-bizagi-wp-project-attachments-list li").hide(10,function(){$(this).show()})},prepareFilesToSave:function(e,t){for(var i=[],a="COMMENTS"===e?this.attchComments[t]:this.attchDiscussions,s=[],n=0,o=(a=a||{addition:[],remove:[]}).addition.length-1;n<=o;n++)i.push({guid:a.addition[n].guid,name:a.addition[n].name}),s.push(a.addition[n].guid);return{attachments:i,attachmentsToCreate:s,attachmentsToDelete:a.remove}},onClickCancel:function(e){e.preventDefault();this.resetDiscussionAttachments(),this.onClosePopupDiscussion(),this.plugins.attchDiscussions.cancelFilesUpload()},onClosePopupDiscussion:function(){this.resetFormDiscussion(),this.plugins.attchDiscussions.destroy(),this.dialogBoxDiscussion.formContent.dialog("destroy"),this.dialogBoxDiscussion.formContent.detach()},onOpenPopupDiscussion:function(){var e=this;e.plugins.attchDiscussions=e.applyFileAttachments("DISCUSSIONS"),e.dialogBoxDiscussion.formContent.parent().css("z-index",10001),e.dialogBoxDiscussion.formContent.parent().parent().find(".ui-widget-overlay").css("z-index",10001),setTimeout(function(){e.form.subject.focus()},50)},onSubmitFormDiscussion:function(e){e.preventDefault();var t,i=this;i.validateAddDiscussionForm(i.dialogBoxDiscussion.formContent)&&(i.form.edition.guid?(t=i.form.edition.guid,$.proxy(i.sendDataUpdateDiscussion(t),i)):(t=Math.guid(),$.proxy(i.sendDataInsertDiscussion(t),i)))},restrictedEventsHandler:function(){var e=this.getContent();$("#ui-bizagi-wp-project-discussions-list-wrapper",e).on("click",".bz-bizagi-wp-project-discussions-attachment-itemwrapper",$.proxy(this.switchCommentsEvents,this))},eventsHandler:function(){var e=this,t=e.getContent();e.form.buttonShowFormNewDiscussion.on("click",$.proxy(e.onNotifyOpenPopup,e)),e.form.buttonCancel.on("click",$.proxy(e.onClickCancel,e)),e.form.buttonAddDiscussion.on("click",$.proxy(e.onSubmitFormDiscussion,e)),e.form.attachments.on("click",".bz-bizagi-wp-project-discussions-attachment-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper",function(t){$(t.target).hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?e.onRemoveFiles($(t.target)):e.onDownloadAttachment($(t.target).closest("li")),t.stopPropagation()}),$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".ui-bizagi-wp-project-discussions-add-comment textarea, .ui-bizagi-wp-project-discussions-comment-buttons-cancel, .ui-bizagi-wp-project-discussions-comment-buttons-share, .ui-bizagi-wp-project-discussion-showmore-comments button, .bz-bizagi-wp-project-discussions-attachment-delete, .ui-bizagi-wp-project-discussion-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper, .ui-bizagi-wp-project-discussions-comment-view, .ui-bizagi-wp-project-discussions-items-edition, .biz-wp-action-edit-discussion",$.proxy(e.switchCommentsEvents,e)),e.sub("changeProjectWidget",function(){e.resetWidget()}),e.sub("OPEN_POPUP_DISCUSSION",$.proxy(e.onNotifyOpenPopup,e))},resetWidget:function(){this.userPictures=[],this.plugins.attchComments&&this.plugins.attchComments.close()},clean:function(){var e=this;for(var t in e.resetWidget(),e.form&&e.form.buttonShowFormNewDiscussion&&e.form.buttonShowFormNewDiscussion.off("click",$.proxy(e.onNotifyOpenPopup,e)),e.plugins)e.plugins[t]&&e.plugins[t].hasOwnProperty("destroy")&&e.plugins[t].destroy&&e.plugins[t].destroy()},mapTempComments:function(e,t){var i=e.find("textarea"),a=t.find("textarea"),s=e.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first(),n=t.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first();a.val(i.val()),n.empty().append(s.html())}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussions",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.discussions],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(e,t,i,a){this._super(e,t,a),this.serviceloadDataPlan=i,this.params=a||{},a.supportNav=!1,this.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var e=this,t=e.getTemplate("project-plan-sidebar");return e.content=t.render({}),$.when(e.areTemplatedLoaded()).done(function(){var t={idPlan:e.params.plan.id};e.params.planChild&&e.params.planChild.id&&(t.idPlan=e.params.planChild.id),e.serviceloadDataPlan.loadData(t,e.getDateServer,e.params),e.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e))}),e.content},loadedWithDataActivities:function(){var e=this;e.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:e.params}),e.pub("notify",{type:"UPDATE_INFO_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:e.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){var e=this;e.serviceloadDataPlan&&(e.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.discussion.sidebar",{},{init:function(e,t,i){this._super(e,t,i),(i=i||{}).supportNav=!1,this.loadTemplates({"project-discussion-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussion.sidebar").concat("#project-discussion-sidebar")})},renderContent:function(){var e=this.getTemplate("project-discussion-sidebar");return this.content=e.render({isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)}),this.content},postRender:function(){var e=this.getContent();$(".ui-bizagi-wp-project-discussions-sidebar-action-add > a",e).on("click",$.proxy(this.onShowPopupDiscussion,this))},onShowPopupDiscussion:function(){this.pub("notify",{type:"OPEN_POPUP_DISCUSSION",args:{}})}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussion.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.discussion.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(e,t,i,a,s,n,o){var r=this;r._super(e,t,o),r.PENDING_PLAN="PENDING",r.EXECUTING_PLAN="EXECUTING",r.CLOSED_PLAN="CLOSED",r.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN",r.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW",r.CONTEXT_PLANCREATE="PLANCREATE",r.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE",r.showActionsPlan=!1,r.projectDashboard=i,r.notifier=a,r.planTemplateCreate=s,r.planPopupEdit=n,r.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var e=this,t=e.getTemplate("plan-action-main");return e.showActionsPlan=e.params.showContextByMenuDashboard!==e.CONTEXT_ACTIVITYPLAN&&e.params.showContextByMenuDashboard!==e.CONTEXT_ACTIVITYPLANOVERVIEW,e.plugins={},e.content=t.render({plan:e.params.plan.name,stateClosedPlan:e.CLOSED_PLAN,currentStatePlan:e.params.plan.currentState,showActionsPlan:e.showActionsPlan}),e.showActionsPlan&&(e.params.plan.contextualized=void 0===e.params.plan.contextualized||e.params.plan.contextualized),e.content},postRender:function(){var e=this,t=e.getContent();e.showActionsPlan&&(e.initilizeActionMenu(),$("a#to-close-plan",t).on("click",$.proxy(e.onClosePlan,e))),e.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(e.onNotifyLoadInfoSummaryPlan,e)),e.clearAlertsOnFocus(),e.planTemplateCreate.sub("planTemplateCreatedSuccess",function(){e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))}),e.planTemplateCreate.sub("planTemplateCreatedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))}),e.planPopupEdit.sub("planEditedSuccess",function(){e.setNamePlan(e.params.plan.name),e.pub("notify",{type:"UPDATE_INFO_PLAN"}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:e.params}),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))}),e.planPopupEdit.sub("planEditedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))}),e.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))},onNotifyExpandedRightSidebar:function(){this.showActionsPlan&&this.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){this.setStatePlan(this.params.plan.currentState),this.setNamePlan(this.params.plan.name)},setStatePlan:function(e){if(e)switch(e.toUpperCase()){case"PENDING":$(".state-pending-plan",this.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",this.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",this.content).show().siblings().hide()}},setNamePlan:function(e){$(".ui-bizagi-wp-project-plan-header .bz-wp-section",this.content).text(bizagi.util.decodeHtmlEntities(e))},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onClickMenuOpenEdition();break;case"delete":this.onClickMenuDeletePlan();break;case"saveastmpl":this.onClickMenuSaveAsTemplate()}},onClickMenuOpenEdition:function(){var e=this.params.plan;this.planPopupEdit.showPopup(this.params,this.dataService,e)},onClickMenuSaveAsTemplate:function(){var e=this;e.planTemplateCreate.showPopupAddTemplatePlan(e.params,e.dataService,e.params.plan.contextualized,e.params.plan.id)},onClickMenuDeletePlan:function(){var e=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done(function(){var t={id:e.params.plan.id};$.when(e.callDeletePlan(t)).always(function(t){if(200===t.status||void 0===t.status){$.extend(e.params.plan,s),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var i=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),a=parseInt(i[0]),s=e.projectDashboard.getParamsByBackFromPlan(e.params,a,!0);e.pub("notify",{type:s.typeContext,args:$.extend(e.params,s.paramsNotify)})}else e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))})})},onSubmitFormPlan:function(e){e.preventDefault()},initilizeActionMenu:function(){$(".ui-bizagi-wp-project-plan-action-menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus(function(){$(this).parent().find(".k-invalid-msg").hide()}).focusout(function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()})},callDeletePlan:function(e){return $.when(this.dataService.deletePlan(e))},clean:function(){var e=this;e.planTemplateCreate.unsub("planTemplateCreatedSuccess"),e.planTemplateCreate.unsub("planTemplateCreatedFailed"),e.planPopupEdit.unsub("planEditedSuccess"),e.planPopupEdit.unsub("planEditedFailed"),e.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var i=this,a=i.getTemplate("plan-state-main").render({});switch(i.params=$.extend(i.params,t.args),i.params.plan.currentState.toUpperCase()){case"PENDING":$(".state-pending",a).show().siblings().hide();break;case"EXECUTING":$(".state-executing",a).show().siblings().hide();break;case"CLOSED":$(".state-closed",a).show().siblings().hide()}i.content.empty().append(a)}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var i=this;i.params=$.extend(i.params,t.args);var a=i.getContent().empty(),s=i.calculateProgress(),n={};n.progress=s,n.progress<33?n.colorBar="Red":n.progress<66?n.colorBar="Yellow":n.colorBar="Green",i.getTemplate("plan-progress-main").render(n).appendTo(a);var o=$(".remaining-days .time-remaining",a),r=$(".remaining-days .days",a).width();o.css("padding-left",(r+7).toString()+"px")},calculateProgress:function(){var e=0,t=this.params.plan.activities.length,i=0;return 0!==t&&(this.params.plan.activities.forEach(function(t){"Completed"===t.workItemState&&e++}),i=Math.round(e/t*100)),i}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(e,t,i){var a=this;a._super(e,t,i),a.PENDING_PLAN="PENDING",a.EXECUTING_PLAN="EXECUTING",a.CLOSED_PLAN="CLOSED",a.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),a.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.params.plan&&(i.params.plan.dueDate?i.params.plan.currentState===i.PENDING_PLAN||i.params.plan.currentState===i.EXECUTING_PLAN?i.updateWidget(e,t):i.sub("LOADED_ACTIVITIES_PLAN",$.proxy(i.updateWidget,i)):i.getContent().empty())},planDatesToStamp:function(e){e.activities&&e.activities.map(function(e){e.estimatedFinishDate&&(e.estimatedFinishDate=new Date(e.estimatedFinishDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())}),e.dueDate&&(e.dueDate=new Date(e.dueDate).getTime()),e.creationDate&&(e.creationDate=new Date(e.creationDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.closedDate&&(e.closedDate=new Date(e.closedDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())},updateWidget:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.planDatesToStamp(i.params.plan);var a=i.getContent().empty();i.params.plan.currentState===i.CLOSED_PLAN&&i.getClosedDatePlan(i.params.plan),$.when(i.getIntervalOnMinutes(i.params.plan)).done(function(e){var t=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.minutesToShowTime*1e3),null,!0),s=t.replace(/\d/g,""),n=i.getKeywordDifferenceDates(i.params.plan),o=bizagi.localization.getResource("workportal-project-plan-state-"+n);o=o.replace("%s",s);var r=t.replace(/\D/g,""),c=i.getSecondDate(i.params.plan),p=i.getWidthBar(i.params.plan,e),u=i.getColorBarByPercent(p),l={fromDate:i.getFormattedDate(new Date(i.getFirstDate(i.params.plan))),toDate:c?i.getFormattedDate(new Date(c)):null,valueOfTimeCalculated:r,messageDescripionDifference:o,percentBar:p,colorBar:u};i.getTemplate("plan-time-main").render(l).appendTo(a)})},getFirstDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate?e.dueDate:e.creationDate;case this.EXECUTING_PLAN:case this.CLOSED_PLAN:return e.startDate}},getSecondDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return null;case this.EXECUTING_PLAN:return e.dueDate;case this.CLOSED_PLAN:return e.closedDate}},getLastActivity:function(e){return JSON.parse(JSON.stringify(e)).sort(function(e,t){return e.finishDate<t.finishDate?1:-1})[0]},getClosedDatePlan:function(e){return e.closedDate=this.getLastActivity(e.activities).finishDate,e.closedDate},getDifferenceBetweenDates:function(e,t){var i=$.Deferred(),a={idUser:bizagi.currentUser.idUser,fromDate:e,toDate:t};return $.when(this.callGetEffectiveDuration(a)).done(function(e){i.resolve(e.minutes)}),i.promise()},getIntervalOnMinutes:function(e){var t=this,i=$.Deferred();switch(e.currentState){case t.PENDING_PLAN:e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(a){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done(function(e){i.resolve({minutesToShowTime:a,minutesCreateToNow:e})})}):e.dueDate<e.creationDate?$.when(t.getDifferenceBetweenDates(e.dueDate,e.creationDate)).done(function(a){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done(function(e){i.resolve({minutesToShowTime:a+e,minutesCreateToNow:e})})}):e.dueDate>e.creationDate&&$.when(t.getDifferenceBetweenDates(e.creationDate,e.dueDate)).done(function(a){$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(e){i.resolve({minutesToShowTime:a+e,minutesCreateToNow:e})})});break;case t.EXECUTING_PLAN:e.dueDate?e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(a){$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done(function(e){i.resolve({minutesToShowTime:a,minutesStartToNow:e})})}):$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(a){$.when(t.getDifferenceBetweenDates(e.startDate,e.dueDate)).done(function(e){i.resolve({minutesToShowTime:a,minutesStartToDueDate:e})})}):$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done(function(e){i.resolve({minutesToShowTime:e})});break;case t.CLOSED_PLAN:$.when(t.getDifferenceBetweenDates(e.startDate,e.closedDate)).done(function(e){i.resolve({minutesToShowTime:e})})}return i.promise()},getKeywordDifferenceDates:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate>Date.now()?"remaining":"exceeded";case this.EXECUTING_PLAN:return e.dueDate?e.dueDate>Date.now()?"remaining":"exceeded":"opened";case this.CLOSED_PLAN:return"executed"}},getRelativeTime:function(e){return bizagi.util.dateFormatter.getRelativeTime(e,null,!1)},getWidthBar:function(e,t){var i={};switch(e.currentState){case this.PENDING_PLAN:if(e.dueDate){if(e.dueDate<Date.now())return 0;var a=t.minutesCreateToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/a)}return 0;case this.EXECUTING_PLAN:if(e.dueDate){if(e.dueDate>Date.now()){a=t.minutesStartToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/a)}return 0}return 0;case this.CLOSED_PLAN:if(e.closedDate>Date.now()){var s=e.closedDate-e.startDate;return i=Date.now()-e.startDate,Math.ceil(100*i/s)}return 100}},getColorBarByPercent:function(e){return e<33?"Red":e<66?"Yellow":"Green"},callGetEffectiveDuration:function(e){var t=$.Deferred();return $.when(this.dataService.getEffectiveDuration(e)).done(function(e){t.resolve(e)}),t.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var i=this,a=i.getContent().empty();i.params=$.extend(i.params,t.args),i.params.plan.parentWorkItem&&$.when(i.dataService.getPlanParent({idPlan:i.params.plan.id})).done(function(e){if(i.params.plan.parent=e,i.params.plan.parent){var t={idParent:i.params.plan.parent.radNumber,nameParent:i.params.plan.parent.displayName,idCase:i.params.plan.parent.idCase,idWorkflow:i.params.plan.parent.idWorkflow,idWorkItem:i.params.plan.parent.idWorkItem,idTask:i.params.plan.parent.idTask,processName:i.params.process?i.params.process:i.params.plan.parent.planName};if(bizagi.util.isEmpty(i.params.plan.parent.guidActivity))i.goToParentCase(a,t);else{var s={idPlan:i.params.plan.id,idActivity:i.params.plan.parent.guidActivity};$.when(i.dataService.getActivity(s)).done(function(e){i.params.plan.parent.allowEdition=e.allowEdition,i.goToParentCase(a,t)})}}}).fail(function(e){})},goToParentCase:function(e,t){e.empty(),this.getTemplate("plan-parent-main").render(t).appendTo(e),$("#go-to-parent-case",e).on("click",$.proxy(this.onClickGoToParentCase,this))},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(e,t,i){var a=this;a.usersMap={},a.plugins={},a.usersInformation=[],a._super(e,t,i),a.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")}),a.auxNoRepeatTypesUser={},a.hashTypesUser={assigned:bizagi.localization.getResource("workportal-project-user-assigned"),owner:bizagi.localization.getResource("workportal-project-user-owner")}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var i=this,a=t.args,s=[],n=[],o=i.getContent().empty(),r=bizagi.currentUser.userGuid,c=bizagi.currentUser.idUser;i.params=$.extend(i.params,t.args),n.push({idUser:c,userGuid:r,userType:["owner"]}),i.usersMap["-"+c+"-"]={picture:"",id:c,guid:r,name:"",userType:["owner"]},s.push(c),$.each(i.params.plan.activities,function(e,t){var a=t.userAssigned,o=t.userAssignedGuid;a===c?-1===$.inArray("Assigned",n[0].userType)&&(n[0].userType.push("Assigned"),i.usersMap["-"+c+"-"].userType.push("Assigned")):(i.usersMap["-"+a+"-"]={picture:"",id:a,guid:o,name:"",userType:["Assigned"]},0===n.filter(function(e){return e.idUser==a}).length&&(n.push({idUser:a,guidUser:o,userType:["Assigned"]}),s.push(a)))}),i.activitiesUsers=n,i.params=a,i.getTemplate("plan-users-main").render({owner:n[0],assignee:n.slice(1),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(o),i.initilizeTooltip(),$.when(i.callGetDataUsers(s)).then(function(){i.renderUserProfilesAndImages()})},renderUserProfilesAndImages:function(){var e=this;$.each(e.usersMap,function(t,i){var a=$(".ui-bizagi-wp-userlist li[data-iduser="+i.id+"]",e.content);""!==i.picture?(a.find("img").prop("src",i.picture),$(".bz-wp-avatar-label",a).hide()):i.name?($(".bz-wp-avatar-img",a).hide(),$(".bz-wp-avatar-label",a).html(i.name.getInitials())):console.log("obj.name is undefined")})},callGetDataUsers:function(e){var t,i=this,a=$.Deferred();return t={usersGuids:e.join(),width:50,height:50},$.when(i.dataService.getUsersData(t)).always(function(e){i.usersInformation=e;for(var t=0,s=e.length;t<s;t+=1)void 0===e[t].name?bizagi.log(e[t]+" Id Not Found",e,"error"):i.usersMap["-"+e[t].id+"-"]?(i.usersMap["-"+e[t].id+"-"].picture+=e[t].picture?"data:image/png;base64,"+e[t].picture:"",i.usersMap["-"+e[t].id+"-"].name=e[t].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");a.resolve()}),a.promise()},initilizeTooltip:function(){var e=this;$(".ui-bizagi-wp-userlist > li",e.content).on("mouseenter","",function(t){var i=$(t.target),a=i.closest("[data-iduser]").attr("data-iduser"),s=e.usersInformation.find(function(e){return e.id==a}),n=e.activitiesUsers.find(function(e){return e.idUser==a});s.types=n.userType,s.owner=s.types.find(function(e){return"owner"==e}),s.isAssignee=s.types.find(function(e){return"Assigned"==e});var o=usersAdapter.createJsonUserInfo(s.typesString,s.name,s.username,s.picture?"data:image/png;base64,"+s.picture:void 0,s.email,s.name.getInitials(),s.isAssignee,s.owner,[],[]);i.parent().usertooltip(e,{target:i,user:o})})}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
//# sourceMappingURL=../../../../Maps/desktop/plancomments.desktop.production.js.map
