bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.manager",{},{usersMap:{},init:function(e,t,a,i,n,s,o,r){var l=this;l._super(e,t,r),l.serviceOrderActivitiesByTransitions=o,l.plans={},l.editDialogBox={},l.allIdUsers=[],l.allGuidUsers=[],l.notifier=i,l.planTemplateCreate=n,l.planPopupEdit=s,l.globalHandlersService=bizagi.injector.get("globalHandlersService"),l.usersFromIdPlan=Array(),l.loadTemplates({"plans.manager.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-wrapper"),"plans.manager.empty":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-empty-message"),"plans.manager.users":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-users"),"plans.manager.activities.tooltip":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-activities-tooltip"),"plans.manager.context.menu.content":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.manager").concat("#plans-manager-context-menu-content")})},renderContent:function(){return this.content=$("<div/>"),this.content},postRender:function(){var e=this;e.getCalculatedDateServer(),e.sub("PLANS-VIEW",$.proxy(e.updateView,e)),e.planTemplateCreate.sub("planTemplateCreatedSuccess",function(){e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))}),e.planTemplateCreate.sub("planTemplateCreatedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))}),e.planPopupEdit.sub("planEditedSuccess",function(){var t={histName:e.params.histName,planState:e.params.planState,level:1};e.pub("notify",{type:"PLANS-VIEW",args:$.extend(e.params,t)}),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))}),e.planPopupEdit.sub("planEditedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))})},configureHandlers:function(){var e=this,t=e.getContent();$(".wdg-plans-manager-card",t).on("click",$.proxy(e.onClickPlan,e)),$(".wdg-plans-manager-card .btn-workonit",t).on("click",function(t){t.stopPropagation();var a=$(t.target).closest(".wdg-plans-manager-card").data("plan-id");e.plans[a].activities.forEach(function(t){e.runningActivity(t)&&e.goToWorkOnIt(t.idCase,t.idWorkItem)})})},onClickPlan:function(e){var t=$(e.target).closest(".wdg-plans-manager-card"),a=t.data("plan-id"),i={name:t.data("plan-name"),id:a};this.showPlanDashBoard(i)},showPlanDashBoard:function(e){var t=this,a=new bizagi.workportal.services.behaviors.projectDashboard(t.dataService);t.params.showContextByMenuDashboard="PLANACTIVITIES",t.params.menuPlanDashboard={},t.params.menuPlanDashboard.showCommentsOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments,t.params.menuPlanDashboard.showFilesOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles,t.params.menuPlanDashboard.showTimeLineOptionMenu=a.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine,(e=t.plans[e.id]).name.length>28&&(e.name=e.name.substring(0,29)+"..."),e.contextualized&&delete t.params.flowContext,$.when(a.getRadNumberForPlanDashboard(e.id,e.contextualized)).done(function(a){t.params.radNumber=a;var i={plan:e,level:2,histName:e.name};t.pub("notify",{type:t.params.showContextByMenuDashboard,args:$.extend(t.params,i)})})},deletePlan:function(e){var t=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done(function(){var a={id:e.id};$.when(t.dataService.deletePlan(a)).always(function(e){if(200===e.status||void 0===e.status){$.extend(t.params.plan,a);var i={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,i)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""))}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))})})},executePlan:function(e){var t=this;if(e.activitiesLength>0){var a={idPlan:e.id};$.when(t.dataService.putExecutePlan(a)).done(function(){var a=t.plans[e.id];a&&(a.currentState="EXECUTING",a=$.extend(a,{startDate:t.getDateServer()}),$.when(t.dataService.updatePlan(a)).done(function(){var e={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,e)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-state-change-running"),""))}))})}else t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-action-execute-message-activities-required"),""))},closePlan:function(e){var t=this,a=t.plans[e.id];a&&(a.currentState="CLOSED",$.when(t.dataService.closePlan({idPlan:e.id})).done(function(){$.when(t.dataService.updatePlan(a)).done(function(){var e={histName:t.params.histName,planState:t.params.planState,level:1};t.pub("notify",{type:"PLANS-VIEW",args:$.extend(t.params,e)}),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-success"),""))})}).fail(function(){t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))}))},openPopupEditTemplate:function(){var e=this,t=e.plans[e.selectedPlan.id]||{};e.planPopupEdit.showPopup(e.params,e.dataService,t)},openPopupSaveTemplate:function(){var e=this,t=e.plans[e.selectedPlan.id]||{};e.planTemplateCreate.showPopupAddTemplatePlan(e.params,e.dataService,t.contextualized,t.id)},updateView:function(e,t){var a=this;a.params=t.args,a.getContent().empty();var i=a.getTemplate("plans.manager.wrapper");$.when(a.getData()).done(function(e){if(e.length>0){a.content.empty(),a.arrayPlans=a.processData(e);var t=a.arrayPlans.length,n=a.arrayPlans;n.totalAssignees=t,a.content.append(i.render({plans:n})),$(".wdg-plans-row-dial",a.content).knob(),a.updatePlanDetails(),a.configureHandlers(),a.configureContextMenu(),$("#ui-bizagi-wp-project-homeportal-main").addClass("disabled-right-sidebar").removeClass("enabled-right-sidebar")}else a.content.empty(),a.content.append(a.getTemplate("plans.manager.empty").render())})},getPictureAndName:function(e){var t=this;if(!1===t.thereWasUsersMap&&t.usersMap)for(var a=0;a<t.usersFromIdPlan[e].length;a+=1){var i=t.usersMap[t.usersFromIdPlan[e][a].userAssigned];t.usersFromIdPlan[e][a].picture=i.picture,t.usersFromIdPlan[e][a].name=i.name}},orderActivitiesByTransitions:function(e,t){return this.serviceOrderActivitiesByTransitions.getActivitiesByTransitions(e,t)},processData:function(e){for(var t=e.length,a=0;a<t;a+=1){this.plans[e[a].id]=e[a];var i=e[a].startDate||e[a].creationDate,n=e[a].dueDate;i&&(i=new Date(i),e[a].fromDate=bizagi.util.dateFormatter.getRelativeTime(i,null,!1)),n&&(n=new Date(n),e[a].toDate=bizagi.util.dateFormatter.getRelativeTime(n,null,!1)),e[a].value=0,e[a].completedActivities=0,e[a].activitiesLength=0,e[a].dueDate&&(e[a].dueDateFormat=this.getFormattedDate(new Date(e[a].dueDate))),e[a].locatedState=bizagi.localization.getResource("workportal-project-plan-state-"+e[a].currentState.toLowerCase())}return e},updatePlanDetails:function(){for(var e=this,t=[],a=[],i=0;i<e.arrayPlans.length;i+=1){t.push(e.arrayPlans[i].idUserCreator);var n=e.getMetaData(e.arrayPlans[i].id);$.when(n,e.arrayPlans[i].id).done(function(t,a){e.plans[a].activities=t,e.paintPlanDetails(t,a),e.configureActivitiesTooltip(t,a)}),a.push(n)}$.when.apply($,a).then(function(){$.equalizeHeights(".wdg-plans-manager-card"),e.getUsers(t.concat(e.allIdUsers))})},getUsersFromIdPlan:function(e){var t=this,a=[];return t.usersFromIdPlan[e].map(function(e){var i=t.usersMap[e.userAssigned];a.push(usersAdapter.createJsonUserInfo(e.userAssigned,i.name,i.username,i.picture,i.email,i.name.getInitials(),!1,!1,e.activities,[]))}),a},paintPlanDetails:function(e,t){var a=this,i=e.length,n=0,s=0,o=[],r=[],l=[],c=a.getTemplate("plans.manager.users");a.plans[t].users={};var d,p,u=a.plans[t].startDate||a.plans[t].creationDate,h=$('[data-plan-id="'+a.plans[t].id+'"]',a.content);if(0==i)a.usersFromIdPlan[t]=[{userAssigned:a.plans[t].idUserCreator,activities:[]}];else{a.usersFromIdPlan[t]=[];for(var g=0;g<i;g+=1){var m=e[g].finishDate||e[g].startDate;u=u<m?m:u,"Completed"===e[g].workItemState&&(n+=1,e[g].progress=100),a.runningActivity(e[g])&&(o.push(e[g].name),e[g].progress=0),r.indexOf(e[g].userAssigned)<0?(a.plans[t].users[e[g].userAssigned]=[e[g]],r.push(e[g].userAssigned)):a.plans[t].users[e[g].userAssigned].push(e[g]),a.allIdUsers.indexOf(e[g].userAssigned)<0&&(a.allIdUsers.push(e[g].userAssigned),a.allGuidUsers.push(e[g].userAssigned)),s+=e[g].progress}for(var f=0;f<r.length;f+=1)if(a.usersMap[r[f]]){var v=a.usersMap[r[f]];l.push(v),thereWasUsersMap=!0,a.usersFromIdPlan[t].push({userAssigned:r[f],activities:[]})}else a.thereWasUsersMap=!1,l.push({userAssigned:r[f],picture:"",name:""}),a.usersFromIdPlan[t].push(usersAdapter.createJsonUserInfo(r[f],"","","","","",!1,!1,[],[]));for(var w=0;w<a.plans[t].activities.length;w++)for(var b=0;b<a.usersFromIdPlan[t].length;b++)a.usersFromIdPlan[t][b].userAssigned===a.plans[t].activities[w].userAssigned&&(null==a.usersFromIdPlan[t][b].activities&&(a.usersFromIdPlan[t][b].activities=[]),a.usersFromIdPlan[t][b].activities.push(a.plans[t].activities[w]));s=Math.round(s/i),h.find(".wdg-plans-row-completed").html(n),h.find(".wdg-plans-row-activities-length").html(i),h.find(".wdg-plans-row-dial").val(s).trigger("change"),l.idPlan=a.plans[t].id,h.find(".wdg-plans-users").html(c.render({users:l})),h.find(".moreUsers").click(function(e){e.preventDefault(),e.stopPropagation();var t=$(this).attr("data-plan-id");a.getPictureAndName(t);var i=a.getUsersFromIdPlan(t);a.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:i,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+i.length+")",width:790,height:526,refreshInbox:!1}})}),a.getVisibleButtonWorkonit(a.plans[t],s,o)?(h.find(".wdg-plans-row-activities").html(o.join(",")),h.find(".wdg-plans-workonit-row").show()):(h.find(".wdg-plans-activities-row").hide(),h.find(".wdg-plans-workonit-row").hide())}"PENDING"===a.plans[t].currentState?(d=bizagi.localization.getResource("workportal-general-properties-last-update"),p=a.plans[t].creationDate):"EXECUTING"===a.plans[t].currentState?(d=bizagi.localization.getResource("workportal-general-properties-start-date"),p=a.plans[t].startDate):"CLOSED"===a.plans[t].currentState&&(d=bizagi.localization.getResource("workportal-general-properties-closed-date"),p=u);var k=a.getFormattedDate(new Date(p));h.find(".first-date-plan").html(d+": "+k)},getResource:function(e){return bizagi.localization.getResource(e)},getFormattedDate:function(e){var t=this.getResource("dateFormat"),a=bizagi.util.dateFormatter.formatInvariant(e,!1),i=$("<span class='formatDate'>"+a+"</span>");return bizagi.util.formatInvariantDate(i,t),i.text()},getVisibleButtonWorkonit:function(e,t,a){var i=!1;return"EXECUTING"===e.currentState&&t<100&&a.length>0&&(i=!0),i},goToWorkOnIt:function(e,t){this.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:e,idWorkItem:t})},configureActivitiesTooltip:function(e,t){var a=this,i=a.getTemplate("plans.manager.activities.tooltip");$('[data-plan-id="'+t+'"]',a.content).find(".wdg-plans-activities-row").tooltip({content:function(){var t=$();return e.forEach(function(e){if(a.runningActivity(e)){var n=e.estimatedFinishDate?new Date(e.estimatedFinishDate):null;a.usersMap[e.userAssigned]&&(e.userName=a.usersMap[e.userAssigned].name,e.userPicture=a.usersMap[e.userAssigned].picture,e.formatedEstimatedFinishDate=n?bizagi.util.dateFormatter.formatDate(n,bizagi.localization.getResource("dateFormat")):null);var s=i.render({activity:e});t.push.apply(t,s)}}),t}})},runningActivity:function(e){return"Active"===e.workItemState||"Inactive"===e.workItemState},configureUserTooltip:function(){var e=this;$(".wdg-plans-users > li",e.content).not(".icon-more").on("mouseenter","",function(t){var a=$(t.target),i=a.closest("[data-iduser]").attr("data-iduser"),n=a.closest(".wdg-plans-manager-card").attr("data-plan-id"),s=e.usersFromIdPlan[n].find(function(e){return e.userAssigned==i});if(s&&s.userAssigned==i){var o=[];s.activities.map(function(e){o.push(e.name)}),s=e.usersMap[s.userAssigned];var r=usersAdapter.createJsonUserInfo(s.userAssigned,s.name,s.username,s.picture,s.email,s.name.getInitials(),!1,!1,o,[]);a.closest(".wdg-plans-users").usertooltip(e,{target:a,user:r})}})},getUsers:function(e){for(var t=this,a=[],i=e.length,n=0;n<i;n+=1)t.usersMap[e[n]]||a.push(e[n]);if(a.length>0){var s={usersGuids:e.join(),width:32,height:32};$.when(t.dataService.getUsersData(s)).done(function(e){for(var a=e.length,i=0;i<a;i+=1)t.usersMap[e[i].id]={picture:e[i].picture?"data:image/png;base64,"+e[i].picture:"",name:e[i].name||"",userAssigned:e[i].id,username:e[i].username,email:e[i].email},t.configureAvatar(e[i].id);t.configureUserTooltip()})}else{for(var o=0;o<e.length;o+=1)t.configureAvatar(e[o]);t.configureUserTooltip()}},configureAvatar:function(e){var t=$('[data-iduser="'+e+'"]',this.content);this.usersMap[e].picture?t.find(".bz-wp-avatar-img").attr("src",this.usersMap[e].picture):(t.find(".bz-wp-avatar-img").hide(),t.find(".wdg-plans-row-user-label").html(this.usersMap[e].name.getInitials()).show())},configureContextMenu:function(){var e=this,t=e.getContent(),a=e.getTemplate("plans.manager.context.menu.content");$(".wdg-plans-leftmenu",t).on("click",function(i){i.stopPropagation();var n=$(i.target),s=n.closest(".wdg-plans-manager-card"),o=s.data("plan-id"),r=s.data("plan-name"),l=s.data("plan-current-state"),c=parseInt(s.find(".wdg-plans-row-activities-length").html(),0),d=parseInt(s.find(".wdg-plans-row-completed").html(),0),p=isNaN(c)||isNaN(d)?0:c-d;e.selectedPlan={id:o,name:r,activitiesLength:isNaN(c)?0:c,completed:p<=0};var u=a.render({currentState:l,completed:e.selectedPlan.completed});$(".plans-manager-context-menu-wrapper",t).append(u),u.menu(),e.configureMenuHandlers(u),u.position({my:"left top",at:"left bottom",of:n,collision:"fit"}),u.show(),$(document).one("click",function(){u.remove()}),$(".wdg-plans-manager-card").one("click",function(){u.remove()}),$(".wdg-plans-leftmenu").one("click",function(){u.remove()})})},configureMenuHandlers:function(e){var t=this;$("#edit",e).on("click",function(e){e.stopPropagation(),t.openPopupEditTemplate(t.selectedPlan)}),$("#save",e).on("click",function(e){e.stopPropagation(),t.openPopupSaveTemplate(t.selectedPlan)}),$("#enable",e).on("click",function(e){e.stopPropagation(),t.executePlan(t.selectedPlan)}),$("#delete",e).on("click",function(e){e.stopPropagation(),t.deletePlan(t.selectedPlan)}),$("#close",e).on("click",function(e){e.stopPropagation(),t.closePlan(t.selectedPlan)})},getMetaData:function(e){var t=this,a=$.Deferred(),i={idPlan:e},n={idPlan:e},s={idPlan:e};return $.when(t.dataService.getActivities(i),t.dataService.getWorkitemsPlan(n),t.dataService.getTransitionsByPlan(s)).done(function(e,i,n){var s;s=t.orderActivitiesByTransitions(e,n),t.mergePropertiesActivitiesWithWorkitems(s,i),a.resolve(s)}),a.promise()},getCalculatedDateServer:function(){var e=this;return $.when(e.dataService.getCurrentTimeDateServer()).done(function(t){e.differenceMillisecondsServer=bizagi.util.dateFormatter.getDifferenceBetweenDates(new Date,new Date(t.date),"milliseconds")})},getDateServer:function(){return(new Date).getTime()+this.differenceMillisecondsServer},getData:function(){var e={};return"all"!==this.params.planState&&(e.currentState=this.params.planState),this.dataService.getUserPlans(e)},getEmptyDataMessage:function(){return this.getTemplate("plans.manager.empty")},mergePropertiesActivitiesWithWorkitems:function(e,t){e.forEach(function(e){var a=t.filter(function(t){return t.guidActivity==e.id});a.length>0&&$.extend(e,{startDate:a[0].wiEntryDate||null,finishDate:a[0].wiSolutionDate||null,idWorkItem:a[0].idWorkItem,workItemState:a[0].workItemState,idCase:a[0].idCase,estimatedFinishDate:a[0].wiEstimatedSolutionDate||e.estimatedFinishDate})})},clean:function(){var e=this;e.params={},e.unsub("PLANS-VIEW",$.proxy(e.updateView,e)),e.planTemplateCreate.unsub("planTemplateCreatedSuccess"),e.planTemplateCreate.unsub("planTemplateCreatedFailed"),e.planPopupEdit.unsub("planEditedSuccess"),e.planPopupEdit.unsub("planEditedFailed")}}),bizagi.injector.register("bizagi.workportal.widgets.plans.manager",["workportalFacade","dataService","actionService","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit","bizagi.workportal.services.behaviors.orderActivitiesByTransitions",bizagi.workportal.widgets.plans.manager]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.topmenu",{},{init:function(e,t,a,i){this.params=i,this._super(e,t,i),this.planCreate=a,this.loadTemplates({"plans.topmenu.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.topmenu").concat("#plans-topmenu-wrapper")})},renderContent:function(){var e=this.getTemplate("plans.topmenu.wrapper");return this.content=e.render({}),this.content},postRender:function(){this.configureHandlers()},configureHandlers:function(){var e=this.getContent();$(".wdg-topmenu-add",e).on("click",$.proxy(this.onClickAddPlan,this))},onClickAddPlan:function(){var e=this;e.planCreate.showPopupAddPlan(e.params,e.dataService,!1),e.planCreate.unsub("planCreated"),e.planCreate.sub("planCreated",function(t,a){var i=a.paramsNewPlan,n=i.name;i.name.length>28&&(n=i.name.substring(0,29)+"..."),e.params.radNumber=a.radNumber,e.params.showContextByMenuDashboard="PLANACTIVITIES",e.pub("notify",{type:"PLANACTIVITIES",args:$.extend(e.params,{plan:a.paramsNewPlan,level:2,histName:n})})})}}),bizagi.injector.register("bizagi.workportal.widgets.plans.topmenu",["workportalFacade","dataService","bizagi.workportal.widgets.project.plan.create",bizagi.workportal.widgets.plans.topmenu]),function(e){"use strict";var t={},a=Math.max,i=Math.min;t.c={},t.c.d=e(document),t.c.t=function(e){return e.originalEvent.touches.length-1},t.o=function(){var a=this;this.o=null,this.$=null,this.i=null,this.g=null,this.v=null,this.cv=null,this.x=0,this.y=0,this.w=0,this.h=0,this.$c=null,this.c=null,this.t=0,this.isInit=!1,this.fgColor=null,this.pColor=null,this.dH=null,this.cH=null,this.eH=null,this.rH=null,this.scale=1,this.relative=!1,this.relativeWidth=!1,this.relativeHeight=!1,this.$div=null,this.run=function(){var t=function(e,t){var i;for(i in t)a.o[i]=t[i];a._carve().init(),a._configure()._draw()};if(!this.$.data("kontroled")){if(this.$.data("kontroled",!0),this.extend(),this.o=e.extend({min:void 0!==this.$.data("min")?this.$.data("min"):0,max:void 0!==this.$.data("max")?this.$.data("max"):100,stopper:!0,readOnly:this.$.data("readonly")||"readonly"===this.$.attr("readonly"),cursor:(!0===this.$.data("cursor")?30:this.$.data("cursor"))||0,thickness:this.$.data("thickness")&&Math.max(Math.min(this.$.data("thickness"),1),.01)||.35,lineCap:this.$.data("linecap")||"butt",width:this.$.data("width")||200,height:this.$.data("height")||200,displayInput:null==this.$.data("displayinput")||this.$.data("displayinput"),displayPrevious:this.$.data("displayprevious"),fgColor:this.$.data("fgcolor")||"#87CEEB",inputColor:this.$.data("inputcolor"),font:this.$.data("font")||"Arial",fontWeight:this.$.data("font-weight")||"bold",inline:!1,step:this.$.data("step")||1,rotation:this.$.data("rotation"),draw:null,change:null,cancel:null,release:null,format:function(e){return e},parse:function(e){return parseFloat(e)}},this.o),this.o.flip="anticlockwise"===this.o.rotation||"acw"===this.o.rotation,this.o.inputColor||(this.o.inputColor=this.o.fgColor),this.$.is("fieldset")?(this.v={},this.i=this.$.find("input"),this.i.each(function(t){var i=e(this);a.i[t]=i,a.v[t]=a.o.parse(i.val()),i.bind("change blur",function(){var e={};e[t]=i.val(),a.val(a._validate(e))})}),this.$.find("legend").remove()):(this.i=this.$,this.v=this.o.parse(this.$.val()),""===this.v&&(this.v=this.o.min),this.$.bind("change blur",function(){a.val(a._validate(a.o.parse(a.$.val())))})),!this.o.displayInput&&this.$.hide(),this.$c=e(document.createElement("canvas")).attr({width:this.o.width,height:this.o.height}),this.$div=e('<div style="'+(this.o.inline?"display:inline;":"")+"width:"+this.o.width+"px;height:"+this.o.height+'px;"></div>'),this.$.wrap(this.$div).before(this.$c),this.$div=this.$.parent(),"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(this.$c[0]),this.c=this.$c[0].getContext?this.$c[0].getContext("2d"):null,!this.c)throw{name:"CanvasNotSupportedException",message:"Canvas not supported. Please use excanvas on IE8.0.",toString:function(){return this.name+": "+this.message}};return this.scale=(window.devicePixelRatio||1)/(this.c.webkitBackingStorePixelRatio||this.c.mozBackingStorePixelRatio||this.c.msBackingStorePixelRatio||this.c.oBackingStorePixelRatio||this.c.backingStorePixelRatio||1),this.relativeWidth=this.o.width%1!=0&&this.o.width.indexOf("%"),this.relativeHeight=this.o.height%1!=0&&this.o.height.indexOf("%"),this.relative=this.relativeWidth||this.relativeHeight,this._carve(),this.v instanceof Object?(this.cv={},this.copy(this.v,this.cv)):this.cv=this.v,this.$.bind("configure",t).parent().bind("configure",t),this._listen()._configure()._xy().init(),this.isInit=!0,this.$.val(this.o.format(this.v)),this._draw(),this}},this._carve=function(){if(this.relative){var e=this.relativeWidth?this.$div.parent().width()*parseInt(this.o.width)/100:this.$div.parent().width(),t=this.relativeHeight?this.$div.parent().height()*parseInt(this.o.height)/100:this.$div.parent().height();this.w=this.h=Math.min(e,t)}else this.w=this.o.width,this.h=this.o.height;return this.$div.css({width:this.w+"px",height:this.h+"px"}),this.$c.attr({width:this.w,height:this.h}),1!==this.scale&&(this.$c[0].width=this.$c[0].width*this.scale,this.$c[0].height=this.$c[0].height*this.scale,this.$c.width(this.w),this.$c.height(this.h)),this},this._draw=function(){var e=!0;a.g=a.c,a.clear(),a.dH&&(e=a.dH()),!1!==e&&a.draw()},this._touch=function(e){var i=function(e){var t=a.xy2val(e.originalEvent.touches[a.t].pageX,e.originalEvent.touches[a.t].pageY);t!=a.cv&&(a.cH&&!1===a.cH(t)||(a.change(a._validate(t)),a._draw()))};return this.t=t.c.t(e),i(e),t.c.d.bind("touchmove.k",i).bind("touchend.k",function(){t.c.d.unbind("touchmove.k touchend.k"),a.val(a.cv)}),this},this._mouse=function(e){var i=function(e){var t=a.xy2val(e.pageX,e.pageY);t!=a.cv&&(a.cH&&!1===a.cH(t)||(a.change(a._validate(t)),a._draw()))};return i(e),t.c.d.bind("mousemove.k",i).bind("keyup.k",function(e){if(27===e.keyCode){if(t.c.d.unbind("mouseup.k mousemove.k keyup.k"),a.eH&&!1===a.eH())return;a.cancel()}}).bind("mouseup.k",function(e){t.c.d.unbind("mousemove.k mouseup.k keyup.k"),a.val(a.cv)}),this},this._xy=function(){var e=this.$c.offset();return this.x=e.left,this.y=e.top,this},this._listen=function(){return this.o.readOnly?this.$.attr("readonly","readonly"):(this.$c.bind("mousedown",function(e){e.preventDefault(),a._xy()._mouse(e)}).bind("touchstart",function(e){e.preventDefault(),a._xy()._touch(e)}),this.listen()),this.relative&&e(window).resize(function(){a._carve().init(),a._draw()}),this},this._configure=function(){return this.o.draw&&(this.dH=this.o.draw),this.o.change&&(this.cH=this.o.change),this.o.cancel&&(this.eH=this.o.cancel),this.o.release&&(this.rH=this.o.release),this.o.displayPrevious?(this.pColor=this.h2rgba(this.o.fgColor,"0.4"),this.fgColor=this.h2rgba(this.o.fgColor,"0.6")):this.fgColor=this.o.fgColor,this},this._clear=function(){this.$c[0].width=this.$c[0].width},this._validate=function(e){var t=~~((e<0?-.5:.5)+e/this.o.step)*this.o.step;return Math.round(100*t)/100},this.listen=function(){},this.extend=function(){},this.init=function(){},this.change=function(e){},this.val=function(e){},this.xy2val=function(e,t){},this.draw=function(){},this.clear=function(){this._clear()},this.h2rgba=function(e,t){var a;return e=e.substring(1,7),"rgba("+(a=[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)])[0]+","+a[1]+","+a[2]+","+t+")"},this.copy=function(e,t){for(var a in e)t[a]=e[a]}},t.Dial=function(){t.o.call(this),this.startAngle=null,this.xy=null,this.radius=null,this.lineWidth=null,this.cursorExt=null,this.w2=null,this.PI2=2*Math.PI,this.extend=function(){this.o=e.extend({bgColor:this.$.data("bgcolor")||"#EEEEEE",angleOffset:this.$.data("angleoffset")||0,angleArc:this.$.data("anglearc")||360,inline:!0},this.o)},this.val=function(e,t){if(null==e)return this.v;e=this.o.parse(e),!1!==t&&e!=this.v&&this.rH&&!1===this.rH(e)||(this.cv=this.o.stopper?a(i(e,this.o.max),this.o.min):e,this.v=this.cv,this.$.val(this.o.format(this.v)),this._draw())},this.xy2val=function(e,t){var n,s;return n=Math.atan2(e-(this.x+this.w2),-(t-this.y-this.w2))-this.angleOffset,this.o.flip&&(n=this.angleArc-n-this.PI2),this.angleArc!=this.PI2&&n<0&&n>-.5?n=0:n<0&&(n+=this.PI2),s=n*(this.o.max-this.o.min)/this.angleArc+this.o.min,this.o.stopper&&(s=a(i(s,this.o.max),this.o.min)),s},this.listen=function(){var t,n,s,o,r=this,l=function(e){e.preventDefault();var s=e.originalEvent,o=s.detail||s.wheelDeltaX,l=s.detail||s.wheelDeltaY,c=r._validate(r.o.parse(r.$.val()))+(o>0||l>0?r.o.step:o<0||l<0?-r.o.step:0);c=a(i(c,r.o.max),r.o.min),r.val(c,!1),r.rH&&(clearTimeout(t),t=setTimeout(function(){r.rH(c),t=null},100),n||(n=setTimeout(function(){t&&r.rH(c),n=null},200)))},c=1,d={37:-r.o.step,38:r.o.step,39:r.o.step,40:-r.o.step};this.$.bind("keydown",function(t){var n=t.keyCode;if(n>=96&&n<=105&&(n=t.keyCode=n-48),s=parseInt(String.fromCharCode(n)),isNaN(s)&&(13!==n&&8!==n&&9!==n&&189!==n&&(190!==n||r.$.val().match(/\./))&&t.preventDefault(),e.inArray(n,[37,38,39,40])>-1)){t.preventDefault();var l=r.o.parse(r.$.val())+d[n]*c;r.o.stopper&&(l=a(i(l,r.o.max),r.o.min)),r.change(r._validate(l)),r._draw(),o=window.setTimeout(function(){c*=2},30)}}).bind("keyup",function(e){isNaN(s)?o&&(window.clearTimeout(o),o=null,c=1,r.val(r.$.val())):r.$.val()>r.o.max&&r.$.val(r.o.max)||r.$.val()<r.o.min&&r.$.val(r.o.min)}),this.$c.bind("mousewheel DOMMouseScroll",l),this.$.bind("mousewheel DOMMouseScroll",l)},this.init=function(){(this.v<this.o.min||this.v>this.o.max)&&(this.v=this.o.min),this.$.val(this.v),this.w2=this.w/2,this.cursorExt=this.o.cursor/100,this.xy=this.w2*this.scale,this.lineWidth=this.xy*this.o.thickness,this.lineCap=this.o.lineCap,this.radius=this.xy-this.lineWidth/2,this.o.angleOffset&&(this.o.angleOffset=isNaN(this.o.angleOffset)?0:this.o.angleOffset),this.o.angleArc&&(this.o.angleArc=isNaN(this.o.angleArc)?this.PI2:this.o.angleArc),this.angleOffset=this.o.angleOffset*Math.PI/180,this.angleArc=this.o.angleArc*Math.PI/180,this.startAngle=1.5*Math.PI+this.angleOffset,this.endAngle=1.5*Math.PI+this.angleOffset+this.angleArc;var e=a(String(Math.abs(this.o.max)).length,String(Math.abs(this.o.min)).length,2)+2;this.o.displayInput&&this.i.css({width:(this.w/2+4>>0)+"px",height:(this.w/3>>0)+"px",position:"absolute","vertical-align":"middle","margin-top":(this.w/3>>0)+"px","margin-left":"-"+(3*this.w/4+2>>0)+"px",border:0,background:"none",font:this.o.fontWeight+" "+(this.w/e>>0)+"px "+this.o.font,"text-align":"center",color:this.o.inputColor||this.o.fgColor,padding:"0px","-webkit-appearance":"none"})||this.i.css({width:"0px",visibility:"hidden"})},this.change=function(e){this.cv=e,this.$.val(this.o.format(e))},this.angle=function(e){return(e-this.o.min)*this.angleArc/(this.o.max-this.o.min)},this.arc=function(e){var t,a;return e=this.angle(e),a=this.o.flip?(t=this.endAngle+1e-5)-e-1e-5:(t=this.startAngle-1e-5)+e+1e-5,this.o.cursor&&(t=a-this.cursorExt)&&(a+=this.cursorExt),{s:t,e:a,d:this.o.flip&&!this.o.cursor}},this.draw=function(){var e,t=this.g,a=this.arc(this.cv),i=1;t.lineWidth=this.lineWidth,t.lineCap=this.lineCap,"none"!==this.o.bgColor&&(t.beginPath(),t.strokeStyle=this.o.bgColor,t.arc(this.xy,this.xy,this.radius,this.endAngle-1e-5,this.startAngle+1e-5,!0),t.stroke()),this.o.displayPrevious&&(e=this.arc(this.v),t.beginPath(),t.strokeStyle=this.pColor,t.arc(this.xy,this.xy,this.radius,e.s,e.e,e.d),t.stroke(),i=this.cv==this.v),t.beginPath(),t.strokeStyle=i?this.o.fgColor:this.fgColor,t.arc(this.xy,this.xy,this.radius,a.s,a.e,a.d),t.stroke()},this.cancel=function(){this.val(this.v)}},e.fn.dial=e.fn.knob=function(a){return this.each(function(){var i=new t.Dial;i.o=a,i.$=e(this),i.run()}).parent()}}($),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.plans.filters",{},{init:function(e,t,a){this.params=a,this._super(e,t,a),this.plansLinks=bizagi.injector.get("bizagi.workportal.widgets.decontextualized.plans",a),this.loadTemplates({"plans.filters.wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.decontextualized.plans.filters").concat("#plans-filter-wrapper")})},renderContent:function(){var e,t,a={};return t=this.getTemplate("plans.filters.wrapper"),e=this.getData(),a.items=e.items,this.content=t.render(a),this.content},postRender:function(){this.configureHandlers()},setSelectedFilter:function(e){$(e).addClass("wdg-ftr-selected").siblings().removeClass("wdg-ftr-selected")},onLoadPlansView:function(e,t){this.setSelectedFilter($(".wdg-plan-filter-card[data-data='"+t.args.planState+"']",this.content))},configureHandlers:function(){var e=this,t=e.getContent();$(".wdg-plan-filter-card",t).on("click",$.proxy(e.onClickFilter,e)),e.sub("PLANS-VIEW",$.proxy(e.onLoadPlansView,e))},clean:function(){var e=this.getContent();e&&$(".wdg-plan-filter-card",e).off("click"),this.unsub("PLANS-VIEW",$.proxy(this.onLoadPlansView,this))},getData:function(){return this.plansLinks.getData()},onClickFilter:function(e){var t=$(e.target).closest(".wdg-plan-filter-card"),a=t.data("title"),i=t.data("data");i.toLowerCase();this.setSelectedFilter(t);var n={histName:a,planState:i,level:1};this.pub("notify",{type:"PLANS-VIEW",args:$.extend(this.params,n)})}}),bizagi.injector.register("bizagi.workportal.widgets.plans.filters",["workportalFacade","dataService",bizagi.workportal.widgets.plans.filters]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activities.sidebar",{},{init:function(e,t,a){this._super(e,t,a),a=a||{},this.loadTemplates({"project-plan-activities-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.sidebar").concat("#project-plan-activities-sidebar")})},renderContent:function(){var e=this.getTemplate("project-plan-activities-sidebar");return this.content=e.render({}),this.content}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activities.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activities.sidebar],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.create",{},{init:function(e,t,a,i){var n=this;n.params=i,n.contextualized,n._super(e,t,i),n.notifier=a,n.loadTemplates({"plan-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.create").concat("#plan-create")}),n.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.initPlugins()},initPlugins:function(){var e=this,t=e.getTemplate("plan-create");e.dialogBox.formContent=t.render({}),e.dialogBox.elements={inputName:$("#input-name-plan",e.dialogBox.formContent),inputTemplate:$("#templates-plan",e.dialogBox.formContent),buttonSave:$("#button-accept-create-plan",e.dialogBox.formContent),buttonCancel:$("#button-cancel-create-plan",e.dialogBox.formContent)},e.dialogBox.elements.buttonSave.on("click",$.proxy(e.onClickSavePlan,e)),e.dialogBox.elements.buttonCancel.on("click",$.proxy(e.closeDialogBox,e)),e.notifier=bizagi.injector.get("notifier")},closeDialogBox:function(){this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach(),this.dialogBox.templateGuid=""},showPopupAddPlan:function(e,t,a){var i=this;i.params=e,i.dataService=t,i.contextualized=a,i.content=$("<div></div>"),i.initPlugins(),i.dialogBox.elements.inputTemplate.html(""),i.dataService.getTemplatesByParentWorkItem({parentWorkItem:e.guidWorkItem}).done(function(e){var t={combo:[],id:"templates"};t.combo=e,i.dialogBox.elements.inputTemplate.uicombo({isEditable:!1,data:t,itemValue:function(e){return e.id},itemText:function(e){return e.name},onChange:function(e){var t=e.ui.data("value");i.dialogBox.elements.inputTemplate.val(t),i.dialogBox.templateGuid=t},css:"display: none"}),i.dialogBox.elements.inputTemplate.keydown(function(){8!=event.keyCode&&46!=event.keyCode||(event.preventDefault(),i.dialogBox.templateGuid="",i.dialogBox.elements.inputTemplate.val(""),$("input",i.dialogBox.elements.inputTemplate).val(""))}),e.length>0?$(".field-template",i.dialogBox.formContent).show():$(".field-template",i.dialogBox.formContent).hide()}).fail(function(){$(".field-template",i.dialogBox.formContent).hide()}),i.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-popup-title-add-plan"),maximize:!1,close:function(){i.dialogBox.formContent.dialog("destroy"),i.dialogBox.formContent.detach()}})},onClickSavePlan:function(e){e.preventDefault();this.validateParams()&&this.createNewPlan()},createNewPlan:function(){var e=this,t=e.params.guidWorkItem||null,a={idUserCreator:bizagi.currentUser.idUser,id:void 0,startDate:null,creationDate:null,parentWorkItem:t,description:null,currentState:"PENDING",name:e.dialogBox.elements.inputName.val(),waitForCompletion:!0,dueDate:null,contextualized:e.contextualized,idTemplate:e.dialogBox.templateGuid};$.when(e.sendDataInsertPlan(a)).then(function(t){(a=$.extend(a,{id:t.id})).activities=[],a.users=[];var i=new bizagi.workportal.services.behaviors.projectDashboard(e.dataService);e.params.menuPlanDashboard={},e.params.menuPlanDashboard.showCommentsOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonComments,e.params.menuPlanDashboard.showFilesOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonFiles,e.params.menuPlanDashboard.showTimeLineOptionMenu=i.getMenuDashboardSecurity(bizagi.menuSecurity).isVisibleButtonTimeLine,a.name=bizagi.util.encodeHtml(a.name),$.when(i.getRadNumberForPlanDashboard(a.id,a.contextualized)).done(function(t){e.pub("planCreated",{paramsNewPlan:a,radNumber:t}),e.closeDialogBox(),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-created"),""))})})},validateParams:function(){var e=this.dialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1},sendDataInsertPlan:function(e){var t=$.Deferred();return $.when(this.dataService.postPlan(e)).always(function(e,a,i){201===i.status?t.resolve(e):t.reject()}),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.create",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.create]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.edit",{},{init:function(e,t,a,i){var n=this;n.params=i,n.planToEdit,n._super(e,t,i),n.notifier=a,n.loadTemplates({"plans.manager.popup.edit.plan":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.edit").concat("#plans-manager-popup-edit-plan")}),n.editDialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){},closeEditDialogBox:function(){this.editDialogBox.elements.inputDueDate.datepicker("destroy"),this.editDialogBox.formContent.dialog("destroy"),this.editDialogBox.formContent.detach()},showPopup:function(e,t,a){var i=this,n=$.Deferred();return i.planToEdit=a,i.initEditDialogBox(a),i.editDialogBox.elements.inputName.val(bizagi.util.decodeHtmlEntities(a.name)),i.editDialogBox.elements.inputDesc.val(bizagi.util.decodeHtmlEntities(a.description)),i.editDialogBox.elements.inputWaitForCompletion.prop("checked",a.waitForCompletion),i.editDialogBox.elements.inputDueDate.datepicker(),i.editDialogBox.elements.inputDueDate.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI()),a.dueDate&&i.editDialogBox.elements.inputDueDate.datepicker("setDate",new Date(a.dueDate)),i.editDialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-editplan"),maximize:!0,close:function(e,t){i.editDialogBox.elements.inputDueDate.datepicker("destroy"),i.editDialogBox.formContent.dialog("destroy"),i.editDialogBox.formContent.detach(),n.resolve()}}),n.promise()},initEditDialogBox:function(e){var t=this,a=t.getTemplate("plans.manager.popup.edit.plan");t.editDialogBox.formContent=a.render(e),t.editDialogBox.elements={inputName:$("#input-name-plan",t.editDialogBox.formContent),inputDesc:$("#input-desc-plan",t.editDialogBox.formContent),inputDueDate:$("#input-dueDate-plan",t.editDialogBox.formContent),inputWaitForCompletion:$("#input-waitForCompletion",t.editDialogBox.formContent),buttonSave:$("#button-accept-edit-plan",t.editDialogBox.formContent),buttonCancel:$("#button-cancel-edit-plan",t.editDialogBox.formContent)},t.editDialogBox.elements.buttonSave.on("click",$.proxy(t.saveEditedPlan,t)),t.editDialogBox.elements.buttonCancel.on("click",$.proxy(t.closeEditDialogBox,t))},saveEditedPlan:function(e){e.preventDefault();var t=this;t.validateEditDialogBoxParams()&&$.when(t.getParamsUpdatePlan()).done(function(e){$.when(t.dataService.updatePlan(e)).done(function(){t.closeEditDialogBox(),t.pub("planEditedSuccess",{paramsEditPlan:e})}).fail(function(){t.pub("planEditedFailed")})})},getParamsUpdatePlan:function(){var e=this,t=$.Deferred(),a={};(a=e.planToEdit).name=e.editDialogBox.elements.inputName.val(),a.description=e.editDialogBox.elements.inputDesc.val(),0!==e.editDialogBox.elements.inputWaitForCompletion.length&&(a.waitForCompletion=e.editDialogBox.elements.inputWaitForCompletion.prop("checked"));var i=e.editDialogBox.elements.inputDueDate.datepicker("getDate");if(i){var n={idUser:bizagi.currentUser.idUser,date:i.getTime()};$.when(e.dataService.getEndHourWorkingByDate(n)).done(function(e){a.dueDate=e.dateTime,t.resolve(a)})}else t.resolve(a);return t.promise()},validateEditDialogBoxParams:function(){var e=this.editDialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.edit",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.edit],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.template.create",{},{init:function(e,t,a){var i=this;i.params=a,i.contextualized,i.idPlanSelected,i._super(e,t,a),i.loadTemplates({"plan-template-create":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.template.create").concat("#plan-template-create")}),i.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.initPlugins()},initPlugins:function(){var e=this,t=e.getTemplate("plan-template-create");e.dialogBox.formContent=t.render({}),e.dialogBox.elements={inputName:$("#input-name-template",e.dialogBox.formContent),buttonSave:$("#button-accept-create-template",e.dialogBox.formContent),buttonCancel:$("#button-cancel-create-template",e.dialogBox.formContent)},e.dialogBox.elements.buttonSave.on("click",$.proxy(e.onClickSaveTemplate,e)),e.dialogBox.elements.buttonCancel.on("click",$.proxy(e.closeDialogBox,e))},closeDialogBox:function(){this.dialogBox.formContent.dialog("destroy"),this.dialogBox.formContent.detach()},showPopupAddTemplatePlan:function(e,t,a,i){var n=this;n.params=e,n.dataService=t,n.contextualized=a,n.idPlanSelected=i,n.content=$("<div></div>"),n.initPlugins(),n.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-action-popup-save-as-template"),maximize:!1,close:function(e,t){n.dialogBox.formContent.dialog("destroy"),n.dialogBox.formContent.detach()}})},onClickSaveTemplate:function(e){e.preventDefault();var t=this;if(t.validateSaveDialogBoxParams()){var a={idPlan:t.idPlanSelected,name:t.dialogBox.elements.inputName.val()};$.when(t.dataService.createTemplateByPlan(a)).done(function(){t.closeDialogBox(),t.pub("planTemplateCreatedSuccess",{})}).fail(function(){t.pub("planTemplateCreatedFailed",{})})}},validateSaveDialogBoxParams:function(){var e=this.dialogBox.elements.inputName;if(e.val()&&""!==e.val())return!0;var t=bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return e.next().find("span").html(t),!1}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.template.create",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.template.create]),bizagi.workportal.widgets.admin.caseSearch.extend("bizagi.workportal.widgets.reassigncase",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"admin.case.search":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search"),"admin.case.search.fields":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-fields"),"admin.case.search.button":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-buttons"),"admin.case.search.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-result"),"admin.case.search.pagination":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-pagination"),"admin.case.search.invalidate":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-invalidate"),"admin.case.search.reassign":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign"),"admin.case.search.reassign.form":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-reassign-form"),"admin.case.search.action.result":bizagi.getTemplate("bizagi.workportal.desktop.widgets.admin.caseSearch").concat("#ui-bizagi-workportal-widget-admin-case-search-action-result"),useNewEngine:!1})},getWidgetName:function(){return bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE},renderContent:function(){var e,t=this.getTemplate("admin.case.search");return e=this.content=$.tmpl(t,{}),this.loadtemplates(),e},loadtemplates:function(){var e=this;e.generalContentTmpl=e.getTemplate("admin.case.search"),e.fieldsContentTmpl=e.getTemplate("admin.case.search.fields"),e.buttonContentTmpl=e.getTemplate("admin.case.search.button"),e.resultContentTmpl=e.getTemplate("admin.case.search.result"),e.paginationTmpl=e.getTemplate("admin.case.search.pagination"),e.invalidateContentTmpl=e.getTemplate("admin.case.search.invalidate"),e.reassignContentTmpl=e.getTemplate("admin.case.search.reassign"),e.reassignFormTmpl=e.getTemplate("admin.case.search.reassign.form"),e.actionResultContentTmpl=e.getTemplate("admin.case.search.action.result")},postRender:function(){this.maxElemShow=10,this.maxPageToShow=5,this.processNavigation=[],this.setupData()},setupData:function(){var e=this,t={cases:[]},a=[];e.setupInitialData(),e.setupDatePicker(),e.setupProcessTree(),e.setupMainButtons(),t.cases.push({idCase:e.params.data.idCase,idWorkItem:e.params.data.idWorkItem}),a.push({taskItem:e.params.data.idCase+": "+e.params.data.idtask,idWorkItem:e.params.data.idWorkItem}),e.selectedTasks=t,e.selectedTasksToShow=a,e.showReassignForm(e.content,e.selectedTasksToShow)},setupInitialData:function(){var e,t=this,a=t.getContent();t.buttonBackAction="backToMainForm",t.selectedUserId="",t.selectedUserName="",t.selectedTasks="",t.selectedTasksToShow="",t.searchParams="",t.processTree="",$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle")),$("#mainForm",a).remove(),$("#dinamicContent",a).remove(),$("#case-search-log-data-buttonset",a).remove(),e=$.tmpl(t.reassignFormTmpl,{}),a.append(e)},setupDatePicker:function(){var e=this.getContent();$(".biz-wp-form-datepicker",e).datepicker({controlType:"select",dateFormat:"dd/mm/yy"})},setupProcessTree:function(){var e=this,t=e.getContent();bizagi.treeRoutSelected=[],$("#treeLinksId").remove(),e.processTree=new bizagi.workportal.widgets.processtree(e.workportalFacade,e.dataService,$.extend(e.params,{canvas:$("#processTree",t)})),e.processTree.render()},setupUsersSearchForm:function(){var e=this,t=e.getContent(),a=$.Deferred();$("#biz-wp-users-table-form").html(""),e.usersTable=new bizagi.workportal.widgets.userstable(e.workportalFacade,e.dataService,$.extend(e.params,{canvas:$("#biz-wp-users-table-form",t),userLinkLabel:[bizagi.localization.getResource("workportal-widget-admincasesearch-reassign")],parentDef:a})),e.usersTable.render(),$.when(a).done(function(t,a){e.assignEventReassignLinks(t,a)})},findResults:function(e,t,a){var i=this;t.Page=a||1,$.when(i.dataService.getAdminCasesList(t)).done(function(a){if($(".biz-wp-table").remove(),$(".case-search-action-wrapper").remove(),$("#biz-wp-table-summary-wrapper").remove(),i.totalRecords=a.records,i.totalPages=a.total,a.rows.length>0){i.showCasesSearchResultFrame(e,a),i.setupActionsButton(e);var n,s=i.maxPageToShow>i.totalPages?i.totalPages:i.maxPageToShow,o=$("#biz-wp-table-pager-wrapper"),r={};r.pagination=i.totalPages>1,r.page=a.page,r.pages={};for(var l=1;l<=s;l++)r.pages[l]={pageNumber:l};n=$.tmpl(i.paginationTmpl,r).html(),o.append(n),$("ul").bizagiPagination({maxElemShow:i.maxElemShow,totalPages:i.totalPages,actualPage:a.page,listElement:$("#biz-wp-table-pager-wrapper"),clickCallBack:function(a){i.findResults(e,t,a.page)}})}else bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-authentication-log-none"),"Bizagi","warning")}).fail(function(e){bizagi.log(e)})},showCasesSearchResultFrame:function(e,t){var a=this,i=a.preprocessResultList(t.headers,t),n=$.tmpl(a.resultContentTmpl,{headers:t.headers,rows:i}),s=$.tmpl(a.invalidateContentTmpl,{}),o=$.tmpl(a.reassignContentTmpl,{});$("#mainForm",e).hide(),$("#dinamicContent",e).html(n),$(".case-search-action-wrapper",e).append(s),$(".case-search-action-wrapper",e).append(o),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title")),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide(),$("#btn-admin-case-back",e).css("display","inline"),a.setupActivitiesLink(e),a.setupGraphicQueryEvent(e)},preprocessResultList:function(e,t){for(var a=[],i=t.rows.length,n=0;n<i;n++)a.push(this.processResultItem(e,t.rows[n]));return a},processResultItem:function(e,t){var a,i,n,s,o=this,r=t.data,l=t.idCase,c=t.idWorkFlow,d=[],p=[],u=[],h=-1,g=0,m=!1;for(p.push({id:"checkCaseAdmin",value:l});h++<e.length-1;)switch(e[h].fieldName){case o.columnsID.caseNumber:p.push({id:"caseNumber",value:{idCase:l,caseNumber:r[g]}}),g++;break;case o.columnsID.process:p.push({id:"idWorkItem",value:r[g]}),g++;break;case o.columnsID.userName:case o.columnsID.task:case o.columnsID.taskDueDate:if(void 0===a){for(var f=r.length;f-- >0;)if(Array.isArray(r[f])){a=r[f],m=!0;break}g++}m?(e[h].fieldName==o.columnsID.taskDueDate&&r.splice(h,1),n=a[0],o.columnsID.userName==e[h].fieldName?(p=p.concat(o.processTaskObjectUser(n)),-1==u.indexOf(o.columnsID.userName)&&u.push(o.columnsID.userName)):o.columnsID.task==e[h].fieldName?(p=p.concat(o.processTaskObject(n,l)),-1==u.indexOf(o.columnsID.task)&&u.push(o.columnsID.task)):o.columnsID.taskDueDate==e[h].fieldName&&(p=p.concat(o.processTaskObjectDate(n)),-1==u.indexOf(o.columnsID.taskDueDate)&&u.push(o.columnsID.taskDueDate))):e[h].fieldName==o.columnsID.taskDueDate&&(p=p.concat({estimatedSolutionDate:r[h]}),-1==u.indexOf(o.columnsID.taskDueDate)&&u.push(o.columnsID.taskDueDate));break;case o.columnsID.processCreationDate:p.push({id:"processCreationDate",value:r[g]}),g++;break;case o.columnsID.processDueDate:p.push({id:"processDueDate",value:r[g]}),g++;break;default:p.push({id:"customField",value:r[g]}),g++}if(p.push({id:"viewProcess",value:{idCase:l,idworkflow:c}}),d.push({attr:"first_row",data:p}),(i=a?a.length:0)>1){s=u.length;for(var v=1;v<i;v++){var w=[];for(f=-1;f++<s-1;)u[f]==o.columnsID.task?w.push(o.processTaskObject(a[v],l)):u[f]==o.columnsID.taskDueDate?w.push(o.processTaskObjectDate(a[v])):u[f]==o.columnsID.userName&&w.push(o.processTaskObjectUser(a[v]));d.push({attr:"next_row",data:w})}}return{data:d,totalTask:i}},processTaskObject:function(e,t){return{taskName:e.taskName,colorState:e.colorState,idCase:t,idWorkItem:e.idWorkItem,idTask:e.idTask}},processTaskObjectDate:function(e){var t={};return e.estimatedSolutionDate?t.estimatedSolutionDate=e.estimatedSolutionDate:t.estimatedSolutionDate="",t},processTaskObjectUser:function(e){var t={};return e.assignee?t.userName=e.assignee:t.userName="",t},invalidateCases:function(e){var t=this,a={cases:[]};$("input:checkbox[name=CaseAdmin]:checked",e).each(function(){var e=$(this).val();a.cases.push({idCase:e})}),0==a.cases.length?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-empty-msg"),"Bizagi","warning"):$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-confirm-msg"),"Bizagi","warning")).done(function(){var i=$("#txtReason",e).val(),n={action:"abort",cases:JSON.stringify(a),reason:i};$.when(t.dataService.abortReassignItems(n)).done(function(a){t.showActionResultFrame(e,a.response,"invalidate")}).fail(function(e){bizagi.log(e)})})},showReassignTasksFrame:function(e){var t={cases:[]},a=[];$("input:checkbox[name=workItemAdmin]:checked",e).each(function(){var e=$(this).val();e=e.split("|"),t.cases.push({idCase:e[0],idWorkItem:e[1]}),a.push({taskItem:e[0]+": "+e[2],idWorkItem:e[1]})}),0==a.length?bizagi.showMessageBox(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-empty-msg"),"Bizagi","warning"):(this.selectedTasks=t,this.selectedTasksToShow=a,this.showReassignForm(e,a))},showReassignForm:function(e,t){this.buttonBackAction="backToCases";var a=$.tmpl(this.reassignFormTmpl,{tasks:t});$("#dinamicContent",e).hide(),$("#dinamicContent2",e).html(a),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide(),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-reassign-title")),this.setupUsersSearchForm()},reassignTasks:function(){var e=this,t=e.getContent(),a={action:"reassignItems",cases:JSON.stringify(e.selectedTasks),idNewUser:e.selectedUserId};$.when(e.dataService.reassignCurrent(a)).done(function(a){e.showActionResultFrame(t,a.response,"reassign")}).fail(function(e){bizagi.log(e)})},showActionResultFrame:function(e,t,a){var i=t.length>1?"-several":"",n="",s="",o=[];if("invalidate"==(i=a+i))for(var r=0;r<t.length;r++)1==t[r].deleted?(n=t[r].idCase,n+=r+1<t.length?", ":"",o[0]=!0):(s=t[r].idCase,s+=r+1<t.length?", ":"",o[1]=!1);else if("invalidate-several"==i)for(r=0;r<t.length;r++)1==t[r].deleted?(n+=t[r].idCase,n+=r+1<t.length?", ":"",o[0]=!0):(s+=t[r].idCase,s+=r+1<t.length?", ":"",o[1]=!1);else if("reassign"==i)for(r=0;r<t.length;r++)1==t[r].reassigned?(n+=t[r].idCase,n+=r+1<t.length?", ":"",o[0]=!0):(s=t[r].idCase,s+=r+1<t.length?", ":"",o[1]=!1);else if("reassign-several"==i){n+="<br/><br/>",s+="<br/><br/>";for(r=0;r<t.length;r++)1==t[r].reassigned?(n+=t[r].idCase+"<br/>",o[0]=!0):(s+=t[r].idCase+"<br/>",o[1]=!1);n+="<br/>",s+="<br/>"}var l=$.tmpl(this.actionResultContentTmpl,{action:i,resultStatus:o});l=(l=(l=(l=l[0].innerHTML.replace("{0}","<strong>"+n+"</strong>")).replace("{3}","<strong>"+s+"</strong>")).replace("{1}",this.selectedUserName)).replace("{1}",this.selectedUserName),"invalidate"==a&&$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-invalidate-result-title")),$("#mainForm",e).html(""),$("#dinamicContent",e).css("display","inline"),$("#dinamicContent",e).html(l),$("#dinamicContent2",e).remove(),$("#usersTable",e).remove(),$("#btn-admin-case-back",e).css("display","none"),$("#btn-admin-case-search-clear",e).css("display","none"),$("#btn-admin-case-search",e).css("display","none"),$("#btn-admin-case-finish",e).css("display","inline"),$("#biz-wp-userstable-wrapperform").hide(),$("#biz-wp-userstable-wrapperlist").hide(),this.usersTable.resultStatus=-1==o.indexOf(!1)},setupMainButtons:function(){var e=this,t=e.getContent(),a=$.tmpl(e.buttonContentTmpl,{});t.append(a);var i=$("#case-search-log-data-buttonset",t);$("#btn-admin-case-search-clear",i).click(function(a){$(".biz-wp-input-text",t).val(""),$(".biz-wp-form-datepicker",t).val(""),e.setupProcessTree()}),$("#btn-admin-case-search",i).click(function(a){var i="",n="",s="",o="",r="",l=e.processTree.getTreeRouteSelected();l.length>0&&(2==l.length?(i=l[1],s=l[0],n=""):(i=l[l.length-1],n=l[1],s=l[0]));var c={h_action:"getCases",I_ProcessState:"Running",h_idApp:"",I_Users:"ALL",eventAsTask:!0,orderType:1,order:"",orderField:"",I_radNumber:$("#caseInput").val(),I_idWFClass:s,I_USERFULLNAME:$("#userNameInput").val(),I_USERPOSITION:$("#userPositionInput").val(),I_From__CreationDate:$("#sinceDate").val(),I_To__CreationDate:$("#toDate").val(),h_idWFClassAuth:"",I_idCategory:n,I_idApplication:i,PageSize:e.maxElemShow};""==$("#sinceDate").val()||bizagi.util.isDate($("#sinceDate").val())?""==$("#toDate").val()||bizagi.util.isDate($("#toDate").val())?(e.searchParams=c,e.findResults(t,c)):(o=bizagi.localization.getResource("workportal-general-invalid-date"),r=bizagi.localization.getResource("workportal-widget-admincasesearch-to-date"),o=o.replace("{0}",r),bizagi.showMessageBox(o,"Bizagi","warning")):(o=bizagi.localization.getResource("workportal-general-invalid-date"),r=bizagi.localization.getResource("workportal-widget-admincasesearch-date-since"),o=o.replace("{0}",r),bizagi.showMessageBox(o,"Bizagi","warning"))}),$("#btn-admin-case-back",i).click(function(t){"backToMainForm"==e.buttonBackAction?e.backToMainForm():"backToCases"==e.buttonBackAction&&e.backToCases()}),$("#btn-admin-case-finish",i).click(function(t){e.publish("closeCurrentDialog")})},backToCases:function(){var e=this.getContent();this.buttonBackAction="backToMainForm",$("#dinamicContent",e).show(),$("#dinamicContent2",e).html(""),$("#usersTable").remove(),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-table-title")),$("#btn-admin-case-search-clear",e).hide(),$("#btn-admin-case-search",e).hide()},backToMainForm:function(){var e=this.getContent();$("#mainForm",e).show(),$("#dinamicContent",e).html(""),$("#generalTitle").html(bizagi.localization.getResource("workportal-widget-admincasesearch-subtitle")),$("#btn-admin-case-search-clear",e).show(),$("#btn-admin-case-search",e).show(),$("#btn-admin-case-back",e).css("display","none")},assignEventReassignLinks:function(e,t){this.selectedUserId=e,this.selectedUserName=t,this.reassignTasks()},setupActionsButton:function(e){var t=this;$("#btn-admin-case-invalidate",e).click(function(a){t.invalidateCases(e)}),$("#btn-admin-case-reassign",e).click(function(a){t.showReassignTasksFrame(e)})},setupActivitiesLink:function(e){var t=this;$(".activityClicked",e).click(function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:$(this)[0].getAttribute("data-idworkItem"),idTask:$(this)[0].getAttribute("data-idTask")}),t.publish("closeCurrentDialog")}),$(".caseClicked",e).click(function(){t.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:$(this)[0].getAttribute("data-idCase"),idWorkItem:"",idTask:""}),t.publish("closeCurrentDialog")}),$(".cases-column-header",e).click(function(){var a=$(this)[0].getAttribute("data-columnorder"),i=$(this)[0].getAttribute("data-ordertype"),n=$(this)[0].getAttribute("data-columnOrderName");i="1"==i?0:1,t.searchParams.order=a,t.searchParams.orderType=i,t.searchParams.orderField=n,t.findResults(e,t.searchParams,t.searchParams.Page)})},setupGraphicQueryEvent:function(e){var t=this;$(".biz-wp-diagram-view-icon",e).click(function(){var e=$(this).data("idcase"),a=$(this).data("idworkflow");t.showGraphicQuery({idCase:e,idWorkflow:a})})}});
//# sourceMappingURL=../../../../Maps/desktop/plans-view.desktop.production.js.map
