bizagi.workportal.comments={renderComments:function(e){var t=this,a={},o="",i=new $.Deferred,n={},s=-1,r=bizagi.currentUser.idUser,l=e.canvas,c=e.readOnly||!1;t.setStorage("bufferLocalNewComments_"+e.caseNumber,0),t.setStorage("idCase",e.caseNumber),t.comments=t.workportalFacade.getTemplate("comments"),t.commentsList=t.workportalFacade.getTemplate("comments-list"),t.commentsReplies=t.workportalFacade.getTemplate("comments-replies"),t.commentsDropdown=t.workportalFacade.getTemplate("comments-dropdown"),t.commentsConfirm=t.workportalFacade.getTemplate("comments-confirm"),e.showComments=!0;var m=function(a){n=a.comments,t.setStorage("maxIdComment_"+e.caseNumber,a.maxIdComment),t.setStorage("bufferLocalNewComments_"+e.caseNumber,0)};return $.when(t.getComments({idCase:e.caseNumber},m)).done(function(d){var p,g,u=d.users||[],f=function(e){var t="";switch(e){case 0:t="orange";break;case 1:t="red";break;case 2:t="yellow";break;case 3:t="blue";break;case 4:t="purple";break;case 5:t="green";break;default:t="disable"}return t},h=function(e){$(e).children("li:not(:last)").slideUp("fast"),$("span.reply-toggler > span",e.parent()).removeClass("expanded")},C=function(e){var t=$(".reply-list li",e)||[],a=$(".reply-toggler",e);t.length>1?a.removeClass("hidden"):a.addClass("hidden")},b=function(e){return $.timeago(new Date(e))},x=function(e){var t="";return $.each(u,function(a,o){u[a].Id==e&&(t=o.Picture)}),t},v=function(e){var t="";return $.each(u,function(a,o){u[a].Id==e&&(t=o.DisplayName)}),t},w=function(){$(".comments-text-box").removeClass("comments-reply-box"),$(".comments-text-box li:first-child").data("reply-mode",""),$(".comments-text-box li:first-child").data("id","")},y=function(e,a){return n.totalRecords=d.totalRecords,u=a,k({totalPages:e.totalPages,actualPage:e.actualPage}),$.tmpl(t.commentsList,{comments:e.comments,User:u,CurrentUser:r,RelatedElementId:null,getCategoryColor:f,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:b,getUserPicture:x,getUserName:v,readOnly:c})},k=function(a,o){var i=a.totalPages||1,n=i>1,r=a.actualPage||1,l=$(".comments-pagination")||o,c={};c.pagination=n,c.totalPages=i,c.pages=[],c.page=r,l.empty(),n?l.show():l.hide();for(var m=5>i?i:5,d=1;d<=m;d++)c.pages.push({pageNumber:d});var p=$.tmpl(t.paginationTemplate,c).html();$(l).append(p),$("ul").bizagiPagination({totalPages:c.totalPages,actualPage:c.page,listElement:$("ul",l),clickCallBack:function(a){$.when(t.getComments({idCase:e.caseNumber,idColorCategory:s,pag:a.page})).done(function(e){S(e,e.users,!0)})}})},S=function(e,t){return n.totalRecords=e.totalRecords,$("#comment-list").empty(),(o=y(e,t)).appendTo($("#comment-list")),a.subprocess=$("#comment-list"),R(),o};c||bizagi.util.setInterval({name:"comments",params:{idCase:bizagi.context.idCase},singleton:!0,timeout:3e4,killWhenExitContext:!1,context:'(bizagi.context.widget=="'+t.getWidgetName()+'" && bizagi.context.idCase == "'+e.caseNumber+'" && bizagi.context.commentsFocus)',call:function(e){e=e||{};var a=t.getStorage("maxIdComment_"+e.idCase);$.when(t.dataService.getNewComments({idCase:e.idCase,idLastComment:a})).done(function(a){if(a.newComments>0||a.newReplies>0){var o=a.newComments+a.newReplies,i=t.getStorage("bufferLocalNewComments_"+e.idCase)||o,n=$(".comments-update").data("message").replace(/{totalNewComments}/,o-i);o>i&&($(".comments-update").text(n),$(".comments-update").show().click(function(e){e.isPropagationStopped()||(e.stopPropagation(),$("#filterClear").click())}))}})}}),p=d,g=u,n.totalRecords=p.totalRecords,u=g,o=$.tmpl(t.comments,{comments:p.comments,readOnly:c,User:u,idCase:e.caseNumber,CurrentUser:r,RelatedElementId:null,getCategoryColor:f,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:b,getUserPicture:x,getUserName:v,getCategoryName:function(e){return t.resources.getResource("workportal-widget-comments-"+e)}}),$(".comment-frame .button-category",o).tooltip(),$(o).find("*").off("click"),$(".button-refresh",o).click(function(){$(".comments-update").hide(),$.when(t.getComments({idCase:e.caseNumber,idColorCategory:s},m)).done(function(e){var t=e.users||[];$("#comment-list").empty(),(o=S(e,t)).appendTo($("#comment-list")),a.subprocess=$("#comment-list"),R()})}),$(".make-new-comments",o).click(function(){w(),$(".comments-text-box li:first-child").slideDown("fast"),$(".comment-box",o).focus().fadeIn(),$(this).hide(),$(".action-buttons").show().slideDown("fast"),$(".text-to-reply").hide()}),$(".comment-box",o).blur(function(){0==$(".comments-text-box textarea").val().length&&($(".comments-text-box textarea").val(""),$(".comments-text-box li:first-child").slideUp("fast"),$(".make-new-comments").fadeIn(),$(".action-buttons").hide(),w())}),$(".send-new-comments",o).click(function(){var a=$(".comments-text-box textarea").val();if(0!=a.length){if("true"==$(".comments-text-box li:first-child").data("reply-mode")){var o=$(".comments-text-box li:first-child").data("id"),i=$("li[data-id='"+o+"']");$.when(t.dataService.makeNewReply({idCase:e.caseNumber,idComment:o,comment:a})).done(function(a){t.incrementStorage("bufferLocalNewComments_"+e.caseNumber,1);var o,s,l=(o=a,s=a.users,n.totalRecords=d.totalRecords,u=s,$.tmpl(t.commentsReplies,{Replies:o.Replies,User:u,CurrentUser:r,RelatedElementId:null,getCategoryColor:f,replaceTextToSmiles:t.replaceTextToSmiles,timeAgo:b,getUserPicture:x,getUserName:v,readOnly:c}));$(".reply-list",i).append(l),$(".reply-list li:last",i).show("highlight","slow"),h($(".reply-list",i)),C($(i))})}else $.when(t.dataService.makeNewComment({idCase:e.caseNumber,comment:a})).done(function(a){t.incrementStorage("bufferLocalNewComments_"+e.caseNumber,1);var o=y(a,a.users);$(".reply-toggler",o).addClass("hidden"),$("#comment-list").prepend(o),$("#comment-list li:first").show("highlight","fast")});$(".comments-text-box li:first-child").slideUp("fast"),$(".make-new-comments").show(),$(".action-buttons").hide(),$(".comments-text-box textarea").val(""),$(".time-ago").timeago(),w()}});function N(){$(".categories-dropdownmenu").empty(),$(".categories-dropdownmenu").data("visible",!1)}$(o).delegate(".editBox","keypress",function(e){13==e.keyCode&&$(this).parent().find(".btnSave").click()}),$(o).delegate(".btnSave","click",function(){var e=$(this).parent(),a=e.attr("data-old-icon"),i=e.attr("data-old-text"),n=$(this).siblings(".editBox").val(),s=e.html(i).find("a span.filter-icon"),r=$("#filterText").attr("class");$("#filterText").hasClass("disable")||a!==r||($("#filterText",o).text(n),$(".filter-dropdown").removeClass("is-visible").addClass("is-hidden")),e.removeAttr("data-old-text").html(i).find("a").empty().append(s,n).removeClass("no-pad"),t.dataService.renameCommentCategory({idColorCategory:e.data("category-id"),colorName:n})}),$(o).delegate(".btnDiscard","click",function(){for(var e,t,a=$(this).parent(),o=a.length,i=0;i<o;i++)e=a[i],t=$(e).attr("data-old-text"),$(e).removeAttr("data-old-text").html(t).removeClass("no-pad")});var P=function(e){var a=$(".categories-dropdownmenu"),o=e.referer||$(),i=e.css||"",n=e.idComment||"",s=e.position||{my:"right top",at:"right top",collision:"fit",of:o.selector||o};a.data("name")!=e.name?(N(),a.data("name",e.name||""),P(e)):a.data("visible")?N():$.when(t.dataService.getCommentsCategories()).done(function(r){var l;a.empty(),a.position(s),(l={categories:r.categories,css:i,idComment:n,referer:o},$.tmpl(t.commentsDropdown,{categories:l.categories,css:l.css,idComment:l.idComment,getCategoryColor:f,readOnly:c})).appendTo(a),a.data("visible",!0),a.data("name",e.name||"")})};$("#buttonFilter",o).bind("click",function(){var e={referer:$("#buttonFilter",o),name:"editCategories",css:"editCategories"};c&&(e.position={my:"left bottom",at:"left bottom",collision:"fit",of:this}),P(e)});var T=function(){return $(".comment-controls").data("idcase")};$(o).delegate(".close","click",N),$(o).delegate(".btnEdit","click",function(){var e=$(this),t=e.parent(),a=t.text().replace(/^\s+|\s+$/g,""),o=e.siblings("a").children("span").attr("class").split(" ")[1],i=t.html(),n='<input type="text" class="editBox" value="'+a+'" /> <span class="filter-icon-ctrl btnSave"></span> <span class="filter-icon-ctrl btnDiscard"></span>';t.attr("data-old-icon",o),t.html(n).attr("data-old-text",i).addClass("no-pad"),$(".editBox").select()}),$(o).delegate(".filter-category","click",function(e){if(!e.isPropagationStopped()){var a=$(this).parent().data("category-id"),o=$(".categories-dropdownmenu").data("name"),i=bizagi.util.trim($(this).text());if("setCategories"==o){var n=$(this).data("idcomment");$.when(t.dataService.setCommentCategory({idCase:T,idColorCategory:a,idComment:n})).done(function(){$("#"+n).removeClass(),$("#"+n).addClass("button-category"),$("#"+n).addClass(f(a)),N()})}else $.when(t.dataService.getComments({idCase:T,idColorCategory:a})).done(function(e){var t=$(".comment-filter > #buttonFilter");a>=0?(s=a,$(".button-refresh").data("category-id",a),$("#filterName").removeClass("is-hidden"),$("#filterText").text(i)):($("#filterName").addClass("is-hidden"),$("#filterText").text(""),s=-1),$("#comment-list").empty(),$("#comment-list").append(y(e,e.users)),t.removeClass(),t.addClass("button-category "+f(a)),N(),$(".button-refresh").data("category-id",a),R(),$(".button-refresh").click()});e.stopPropagation()}}),$(o).delegate("#filterClear","click",function(){$("#filterClear").bind("click",function(e){e.isPropagationStopped()||(e.stopPropagation(),s=-1,$(".comment-filter > #buttonFilter").removeClass(),$(".comment-filter > #buttonFilter").addClass("button-category "+f()),$(".button-refresh").data("category-id",""),$("#filterName").addClass("is-hidden"),$("#filterText").text(""),$(".button-refresh").click())})}),c||($(o).on("click",".button-category[data-own='true']",function(e){if(!c&&!e.isPropagationStopped()){e.stopPropagation();P({referer:this,name:"setCategories",css:"setCategories",idComment:$(this).data("id"),position:{my:"right top",at:"left bottom",collision:"fit",of:this}})}}),$(o).on("click",".button-reply",function(e){if(!e.isPropagationStopped()){var t=$(this).data("id"),a=$("li[data-id='"+t+"'] .comment-text").first().text();$(".comments-text-box li:first-child").data("reply-mode","true"),$(".comments-text-box li:first-child").data("id",t),$(".text-to-reply").text(a),$(".text-to-reply").show(),$(".comments-text-box textarea").focus(),$(".comments-text-box").addClass("comments-reply-box"),$(".comments-text-box li:first-child").show().slideDown("fast"),$(".make-new-comments").hide(),$(".action-buttons").show().slideDown("fast"),e.stopPropagation()}}),$(o).on("click",".button-delete",function(e){var a=$(this).parents("li:first"),o=$(this).data("id"),i=a.parent();$.tmpl(t.commentsConfirm).dialog({resizable:!0,modal:!0,title:t.getResource("workportal-widget-comments-title"),buttons:[{text:t.getResource("workportal-widget-comments-delete"),click:function(){if(i.hasClass("reply-list")){var e=a.parents("li:first").data("id");$.when(t.dataService.removeReply({idCase:T,idComment:e,idReply:o}).done(function(e){n(e)}))}else $.when(t.dataService.removeComment({idCase:T,idComment:o}).done(function(e){n(e)}));var n=function(e){e.action?$.when(a.hide("highlight","fast")).done(function(){a.remove(),i.hasClass("reply-list")&&(i.find("li").hide(),i.find("li:last").show(),C(i.parents("li:first")))}):alert(e.message)};$(this).dialog("close"),bizagi.workportal.desktop.popup.closePopupInstance()}},{text:t.getResource("workportal-widget-comments-cancel"),click:function(){$(this).dialog("close")}}]})}));var R=function(){$.each($(".reply-list",o),function(){var e=$(".reply-toggler",$(this).parents("li:first"));$("li",this).length>1?($(this).children("li:not(:last)").hide(),e.removeClass("hidden")):e.addClass("hidden")})};$(o).on("click",".reply-toggler",function(e){var t;e.isPropagationStopped()||(e.stopPropagation(),"hide"!=$(this).data("toggle-action")?(t=$(this).parent().find("ul"),$(t).children("li:not(:last)").slideDown("fast"),$("span",this).addClass("expanded"),$(this).data("toggle-action","hide")):(h($(this).parent().find("ul")),$("span",this).removeClass("expanded"),$(this).data("toggle-action","show")))}),R(),o.appendTo(l),k({totalPages:d.totalPages,actualPage:d.actualPage},$(".comments-pagination")),i.resolve(l)}),i.promise()},getComments:function(e,t){var a=new $.Deferred;return e=e||{},t=t||function(){},$.when(this.dataService.getComments(e)).done(function(e){t(e),a.resolve(e)}),a.promise()},replaceTextToSmiles:function(e){for(var t=e,a="",o={"<br>":"\n","[<]":"&lt;","[>]":"&gt;"};a!=t;)$.each(o,function(e,o){var i=new RegExp(e,"gm");a=t,t=t.replace(i,o,"gm")});return $.each({":)":"smiley",":!":"sarcastic",":$":"embarrassed",":(":"sad",":'(":"cry",";)":"wink",":|":"disappointed",":D":"happy",":o":"surprise",":p":"tongue",":s":"confused"," Y ":"yes"," N ":"no"},function(e,a){var o=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i=new RegExp(o),n="<div class='smiles "+a+"'></div>";t=t.replace(i,n,"g")}),t},setStorage:function(e,t){var a="";return e=e||"",sessionStorage&&(a=sessionStorage.setItem(e,t)),a},incrementStorage:function(e,t){var a=!0;if(sessionStorage){var o=parseInt(this.getStorage(e))+parseInt(t);this.setStorage(e,o)}else a=!1;return a},getStorage:function(e){var t=void 0;return e=e||"",sessionStorage&&(t=sessionStorage.getItem(e)),t}};
//# sourceMappingURL=../../../../Maps/desktop/comments-old.desktop.production.js.map
