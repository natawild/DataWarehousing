bizagi.workportal.widgets.project.base.extend("bizagi.workportal.desktop.widgets.project.plan.activities.form",{},{init:function(t,e,i,a){var n=this;n._super(t,e,a),n.dateFormat=bizagi.localization.getResource("dateFormat"),n.timeFormat=bizagi.localization.getResource("timeFormat"),n.estimatedFinishDateTime,n.MAX_HOURS=9999999,n.plugins={},n.form={},n.notifier=i,n.loadTemplates({"plan-activities-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-plan-activities-form"),"plan-activity-items":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activities.form").concat("#project-activity-items")})},renderContent:function(){var t=this,e=t.getTemplate("plan-activities-main");return t.params.plan.contextualized=void 0===t.params.plan.contextualized||t.params.plan.contextualized,t.content=e.render(t.params.plan),t.content},postRender:function(){var t=this,e=t.getContent();t.sub("GETDATA_FORM_EDIT_ACTIVITIY",function(){return t.getDataActivityForm()}),t.form={name:$("#activity-form-itemname",t.content),description:$("#activity-form-description",t.content),assignee:$("#activity-form-assignee",t.content),date:$("#activity-form-date",t.content),duration:$("#activity-form-duration",t.content),allowEdition:$("#activity-form-allowedition",t.content),sendNotification:$("#activity-form-send-notification",t.content),cancel:$("#project-plan-activity-form-cancel",t.content)},t.initializeAutoComplete(t.form.assignee),t.initializeDatePicker(t.form.date),t.initializeSpiner(t.form.duration),$("#link-add-new-item",e).on("click",$.proxy(t.addNewItem,t)),t.eventsHandler()},initializeItems:function(t){var e=this,i=e.getContent(),a=e.getTemplate("plan-activity-items"),n={};n.items=t;var o=a.render(n),s=$(".list-items",i);s.empty().append(o),$(".inputtext",s).on("change",$.proxy(e.onSaveForm,e))},initializeAutoComplete:function(t){var e=this,i=e.dataService.serviceLocator.getUrl("admin-getUsersListForPlans");t.autocomplete({minLength:2,source:function(t,a){$.ajax({url:i,data:{domain:"",userName:"",fullName:t.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(t){a($.map(t.users,function(t){return{label:t.user,value:t.idUser}})),e.fitList()}})},select:function(i,a){var n=a.item.label;return t.val(n),e.form.IdAssignee=a.item.value,e.onSaveForm(i),e.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{assignee:e.form.IdAssignee}}),!1},focus:function(){return!1},change:function(t,i){return null===i.item&&(e.form.IdAssignee=null,e.form.assignee.val("")),!1}}),$(window).on("resize.activityAssignee",function(){$("#activity-form-assignee",e.content).blur()})},fitList:function(){setTimeout(function(){var t=$("body > ul.ui-autocomplete"),e=$(window).height()-$(t).position().top-10;$(t).css({"max-height":e+"px",overflow:"auto"})})},initializeDatePicker:function(t){var e=this;t.datepicker({onSelect:function(){e.form.duration.val("");e.estimatedFinishDateTime=e.form.date.datepicker("getDate")?e.form.date.datepicker("getDate").getTime()+86399950:void 0,e.onSaveForm()},onClose:function(){""===t.val()&&e.fieldDurationActive(!0)}}),t.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(t){var e,i=this,a=bizagi.clone(i.params.plan.idActivitySelected);function n(t,e){var a=e||$(t.target).val();bizagi.util.isNumeric(a)&&parseInt(a,10)>0?(i.form.date.val(""),i.estimatedFinishDateTime=void 0):$(t.target).val("")}t.spinner({min:1,max:i.MAX_HOURS,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(t){n(t),a===i.params.plan.idActivitySelected&&i.onSaveForm()},spin:function(t,a){n(t,a.value),clearTimeout(e),$("#myInput").val&&(e=setTimeout($.proxy(i.onSaveForm,i),500))}})},onKeyPressInputItem:function(t){var e=this,i=e.getContent();setTimeout(function(){$(t.target).siblings(".showtext").text($(t.target).val()),$(t.target).prop("title",$(t.target).val())},51);var a=t.keyCode||t.which;function n(){setTimeout(function(){$(".list-items .item.edit",i).find(".inputtext").focus();var t=$(".list-items .item.edit",i).find(".inputtext").val();$(".list-items .item.edit",i).find(".inputtext").val(t)},51)}function o(t){$(t.target).closest(".item").removeClass("edit"),$(t.target).closest(".item").next().addClass("edit"),n()}function s(t){$(t.target).closest(".item").removeClass("edit"),$(t.target).closest(".item").prev().addClass("edit"),n()}switch($(".container-items").removeClass("editing-mouse"),a.toString()){case"13":if(""!==$(t.target).val()){$(t.target).closest(".item").removeClass("edit");var r=$(t.target).closest(".item").index();e.addNewItem("",r)}break;case"27":0!==$(t.target).closest(".item").prev().length?s(t):0!==$(t.target).closest(".item").next().length&&o(t),$(t.target).closest(".item").remove(),e.onSaveForm(t);break;case"38":0!==$(t.target).closest(".item").prev().length&&s(t);break;case"40":0!==$(t.target).closest(".item").next().length&&o(t)}},onFocusInputItem:function(t){$(t.target).closest(".item").addClass("edit").siblings().removeClass("edit")},onFocusOutInputItem:function(t){if(""===$.trim($(t.target).val())){var e=$(t.target).closest(".item");$(e).css("display","block").empty().css("background","#E7BA99").animate({backgroundColor:"#FFF",height:"0px"},300,"linear",function(){$(this).remove()})}else $(t.target).closest(".item").removeClass("edit")},onMouseLeaveItem:function(){var t=this.getContent();$(".container-items",t).addClass("editing-mouse")},onClickDeleteItem:function(t){var e=this;$(t.target).closest(".item").off("keyup",".inputtext",$.proxy(e.onKeyPressInputItem,e)),$(t.target).closest(".item").off("click",".item-button.delete",$.proxy(e.onClickDeleteItem,e)),$(t.target).closest(".item").remove(),e.onSaveForm(t)},addNewItem:function(t,e){var i=this.getContent();void 0===e&&-1===(e=$(".list-items .item",i).length-1)&&(e=0);var a={items:[{}]},n=this.getTemplate("plan-activity-items").render(a);$(n).addClass("edit"),0===$(".list-items",i).children().length?$(".list-items",i).append(n):$(".list-items",i).children().eq(e).after(n),$(".inputtext",n).on("change",$.proxy(this.onSaveForm,this)),setTimeout(function(){$(".list-items .item.edit",i).find(".inputtext").focus()},51)},onDeleteDate:function(t){8===t.keyCode&&($(t.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(t){var e=$(t.target);""!==e.val()&&(e.val(bizagi.util.getOnlyNumbersByString(e.val())),this.validateMaxHoursDurationField(e),this.form.date.val(""),this.estimatedFinishDateTime=void 0)},onCancelForm:function(){this.pub("notify",{type:"PLANSIDEBAR",args:this.params})},onSaveForm:function(t){t&&t.preventDefault();var e=this,i=e.getDataActivityForm();i&&$.when(e.dataService.editActivityPlan(i)).always(function(t,i,a){200===a.status&&"success"!==i&&e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-activity-update-message"),""))})},getDataActivityForm:function(){var t=this;if(t.validateParams(t.form.name.val())){var e=t.form.IdAssignee||bizagi.currentUser.idUser,i=t.form.allowEdition.is(":checked")||!1,a=t.form.sendNotification.is(":checked"),n={};return $.each(t.params.plan.activities,function(){var o;this.id===t.params.plan.idActivitySelected&&(t.form.duration.val(bizagi.util.getOnlyNumbersByString(t.form.duration.val())),t.validateMaxHoursDurationField(t.form.duration),this.duration=t.form.duration.val(),this.userAssigned=e,this.userAssignedGuid=e,this.allowEdition=i,this.sendNotification=a,this.description=t.form.description.val(),this.name=t.form.name.val(),this.estimatedFinishDate=t.estimatedFinishDateTime,this.items=(o=[],$(".list-items .inputtext").each(function(){""!==$(this).val().trim()&&o.push({id:void 0,resolved:$(this).closest(".item").find("input[type='checkbox']").is(":checked"),name:$(this).val()})}),o),this.numTotalItems=this.items.length,n=this)}),n}return!1},validateParams:function(t){if(""===t){var e="* "+bizagi.localization.getResource("workportal-project-plan-popup-field-name-required");return this.form.name.next().find("span").html(e),!1}return this.form.name.next().find("span").empty(),!0},onChangeForm:function(t,e){var i=this;i.estimatedFinishDateTime=void 0;var a=e.args.idActivityToShow||i.params.plan.idActivitySelected,n=i.params.plan.activities.filter(function(t){return t.id===a})[0];i.setValuesFormFields(e.args.isEditableFormActivity,n),i.setEnabledFormFields(e.args.isEditableFormActivity,n)},onChangeActivityName:function(t){this.onSaveForm(),this.pub("notify",{type:"UPDATE_ACTIVITY_INFO",args:{displayName:$(t.target).val()}})},setEnabledFormFields:function(t,e){var i=this;$(i.form.date).blur(),t?($(".ui-bizagi-wp-project-plan-activity-action-menu",i.content).show(),$("#activity-form-itemname",i.content).prop("disabled",!1),$("#activity-form-itemname",i.content).removeClass("ui-state-disabled"),$("#activity-form-description",i.content).prop("disabled",!1),$("#activity-form-description",i.content).removeClass("ui-state-disabled"),i.form.assignee.removeClass("ui-state-disabled"),i.activateElement(i.form.assignee),i.fieldDurationActive(!0),i.activateElement(i.form.date),i.form.date.removeClass("ui-state-disabled"),$("#activity-form-allowedition",i.content).prop("disabled",!1),$("#activity-form-send-notification",i.content).prop("disabled",!1),$(".container-items",i.content).addClass("is-editing"),$("#link-add-new-item",i.content).show()):($(".ui-bizagi-wp-project-plan-activity-action-menu",i.content).hide(),$("#activity-form-itemname",i.content).prop("disabled",!0),$("#activity-form-itemname",i.content).addClass("ui-state-disabled"),$("#activity-form-description",i.content).prop("disabled",!0),$("#activity-form-description",i.content).addClass("ui-state-disabled"),i.form.assignee.addClass("ui-state-disabled"),i.deactivateElement(i.form.assignee),i.deactivateElement(i.form.date),i.form.date.addClass("ui-state-disabled"),i.fieldDurationActive(!1),$("#activity-form-allowedition",i.content).prop("disabled",!0),$("#activity-form-send-notification",i.content).prop("disabled",!0),$(".container-items",i.content).removeClass("is-editing"),$("#link-add-new-item",i.content).hide())},setValuesFormFields:function(t,e){var i=this,a=e&&!bizagi.util.isEmpty(e.estimatedFinishDate)?e.estimatedFinishDate:"",n=a?bizagi.util.dateFormatter.getDateFromInvariant(a):"";isNaN(e.estimatedFinishDate)||(n=new Date(e.estimatedFinishDate));var o=n instanceof Date&&n.getTime()<i.getDateServer();$("#project-plan-activity-form",i.content)[0].reset(),$(".list-items .item",i.content).remove(),i.form.name.val(bizagi.util.decodeHtmlEntities(e.name)),i.form.description.val(bizagi.util.decodeHtmlEntities(e.description)),e.userAssigned&&i.setUserAssignedIDGuid(e.userAssigned,e.userAssignedGuid),i.form.date.datepicker("option","minDate",new Date(i.getDateServer())),e.estimatedFinishDate&&o&&i.form.date.datepicker("option","minDate",n),e.estimatedFinishDate&&(i.form.date.datepicker("setDate",n),i.estimatedFinishDateTime=e.estimatedFinishDate),e.duration&&i.form.duration.val(parseInt(e.duration,10)),i.params.plan.parent&&!1===i.params.plan.parent.allowEdition?(e.allowEdition=!1,i.form.allowEdition.parent().hide()):i.form.allowEdition.parent().show(),!0===e.allowEdition?i.form.allowEdition.prop("checked",!0):i.form.allowEdition.prop("checked",!1),!0===e.sendNotification?i.form.sendNotification.prop("checked",!0):i.form.sendNotification.prop("checked",!1),e.numTotalItems>0?($(".container-items h4",i.content).show(),$(".container-items span",i.content).hide(),i.initializeItems(e.items)):t?$(".container-items span",i.content).hide():$(".container-items span",i.content).show()},validateMaxHoursDurationField:function(t){""!==bizagi.util.getOnlyNumbersByString(t.val())&&parseInt(t.val())>this.MAX_HOURS&&t.val(this.MAX_HOURS)},fieldDurationActive:function(t){t?(this.form.duration.prop("disabled",!1),this.form.duration.spinner("option","disabled",!1)):(this.form.duration.prop("disabled",!0),this.form.duration.spinner("option","disabled",!0))},deactivateElement:function(t){t.prop?(t.prop("disabled",!0),t.closest("tr").addClass("ui-bizagi-workportal-opacity")):(t.enable(!1),t.wrapper.closest("tr").addClass("ui-bizagi-workportal-opacity"))},activateElement:function(t){t.prop?(t.prop("disabled",!1),t.closest("tr").removeClass("ui-bizagi-workportal-opacity")):(t.enable(!0),t.wrapper.closest("tr").removeClass("ui-bizagi-workportal-opacity"))},setUserAssignedIDGuid:function(t,e){var i=this;i.callGetDataUsers(t).then(function(t){i.form.assignee.val(t[0].name)}),i.form.IdAssignee=t},eventsHandler:function(){var t=this;t.form.date.on("keydown",$.proxy(t.onDeleteDate,t)),t.form.duration.on("keyup",$.proxy(t.onTypeDuration,t)),t.form.cancel.on("click",$.proxy(t.onCancelForm,t)),t.form.name.on("change",$.proxy(t.onChangeActivityName,t)),t.form.description.on("change",$.proxy(t.onSaveForm,t)),t.form.allowEdition.on("change",$.proxy(t.onSaveForm,t)),t.form.sendNotification.on("change",$.proxy(t.onSaveForm,t)),t.form.name.donetyping(function(){t.onSaveForm()}),t.form.description.donetyping(function(){t.onSaveForm()}),t.form.duration.donetyping(function(){t.onSaveForm()}),$(".list-items",t.content).on("keyup",".inputtext",$.proxy(t.onKeyPressInputItem,t)),$(".list-items",t.content).on("focusout",".inputtext",$.proxy(t.onFocusOutInputItem,t)),$(".list-items",t.content).on("focus",".inputtext",$.proxy(t.onFocusInputItem,t)),$(".list-items",t.content).on("click",".item-button.delete",$.proxy(t.onClickDeleteItem,t)),$(".list-items",t.content).on("mouseleave",".item",$.proxy(t.onMouseLeaveItem,t)),t.sub("EDITACTIVITY",$.proxy(t.onChangeForm,t))},callGetDataUsers:function(t){var e=$.Deferred(),i={usersGuids:t,width:50,height:50};return this.dataService.getUsersData(i).always(function(t){e.resolve(t)}),e.promise()},clean:function(){this.unsub("EDITACTIVITY",$.proxy(this.onChangeForm,this)),$(window).off("resize.activityAssignee")}}),bizagi.injector.register("bizagi.workportal.desktop.widgets.project.plan.activities.form",["workportalFacade","dataService","notifier",bizagi.workportal.desktop.widgets.project.plan.activities.form],!0);
//# sourceMappingURL=../../../../Maps/desktop/editactivity.desktop.production.js.map
